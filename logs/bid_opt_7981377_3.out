========== Env & Dir ==========
Host: node3114
Start: Mon Jan 12 21:20:35 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 3 -> lambda=1000
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1798 keywords from data/gkp/keywords_classified.csv (new=995)
Generating BERT embeddings for 1798 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1798, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-12
  Keywords: 1798, Regions: 4, Matches: 3
  Total combinations: 21576
  Using target day for temporal features: 2026-01-12
  Created 21576 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  Loaded 1749 rows from Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  After cleaning: 1747 rows with unique keywords
  Fuzzy-matched 468 rows using similar-word normalization
  Example fuzzy mappings: ['advanced generative ai courses -> advanced generative ai course', 'ai certification -> artificial intelligence certification', 'ai certification courses -> ai certificate course', 'ai courses -> artificial intelligence course', 'ai for engineers -> ai for engineering']
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             37.99% categorical (Missing)     (n=8196)
  Competition (indexed value)             37.99% numeric (0)               (n=8196)
  Top of page bid (low range)             54.12% numeric (0)               (n=11676)
  Top of page bid (high range)            54.12% numeric (0)               (n=11676)
  _kw_key                                 71.19% categorical (Missing)     (n=15360)
  last_month_searches                     26.64% numeric (0)               (n=5748)
  three_month_avg                         26.64% numeric (0)               (n=5748)
  six_month_avg                           26.64% numeric (0)               (n=5748)
  mom_change                              26.64% numeric (0)               (n=5748)
  search_trend                            26.64% numeric (0)               (n=5748)
  Avg. CPC                                54.12% numeric (0)               (n=11676)
  -------------------------------------------------------------------------------------
  Total: Imputed 95520 missing values (6.61% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (21576, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_ridge_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_ridge_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using Ridge EPC preprocessor from models/ridge_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 9104/21576 rows (dropping 12472 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1915/9104 rows (dropping 7189 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 745347.56)
Loading embeddings from data/clean/unique_keyword_embeddings_bert.csv...
  Loaded 154 rows with complete embeddings
Saved bid bounds debug CSV: opt_results/cache/bert_ridge_xgb_2026-01-12_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded RIDGE (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1915
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_ridge_xgb_2026-01-12_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_ridge_xgb_20260112_212413.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9474F 48-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 96 physical cores, 192 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 759520 rows, 653015 columns and 2096428 nonzeros (Max)
Model fingerprint: 0xaec3a6f1
Model has 1155 linear objective coefficients
Model has 3830 quadratic objective terms
Model has 1915 quadratic constraints
Model has 7660 simple general constraints
  7660 INDICATOR
Variable types: 49790 continuous, 603225 integer (603225 binary)
Coefficient statistics:
  Matrix range     [5e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [1e+03, 1e+03]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [3e-02, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 683480 rows and 603795 columns
Presolve time: 0.37s
Presolved: 87531 rows, 51137 columns, 201419 nonzeros
Presolved model has 3830 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 20629 continuous, 30508 integer (30508 binary)
Performing another presolve...
Presolve removed 52223 rows and 30633 columns
Presolve time: 1.53s
Deterministic concurrent LP optimizer: primal and dual simplex
Showing primal log only...

Concurrent spin time: 0.00s

Solved with dual simplex

Root relaxation: objective 5.345538e+06, 13173 iterations, 0.19 seconds (0.19 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 5345537.86    0 9613          - 5345537.86      -     -    2s
     0     0 1828373.44    0 6642          - 1828373.44      -     -    4s
     0     0 1423470.74    0 5761          - 1423470.74      -     -    4s
     0     0 877484.973    0 4629          - 877484.973      -     -    5s
     0     0 765139.372    0 4040          - 765139.372      -     -    5s
     0     0 631759.691    0 3122          - 631759.691      -     -    6s
     0     0 506058.059    0 3054          - 506058.059      -     -    7s
     0     0 462376.716    0 2411          - 462376.716      -     -    8s
H    0     0                    262051.45777 462340.749  76.4%     -    8s
H    0     0                    264325.92578 462340.749  74.9%     -    8s
H    0     0                    269660.18807 462340.749  71.5%     -    8s
H    0     0                    269966.75596 462340.749  71.3%     -    9s
H    0     0                    270028.35411 462340.749  71.2%     -    9s
H    0     0                    270483.41244 462340.749  70.9%     -    9s
H    0     0                    271140.61452 462340.749  70.5%     -    9s
H    0     0                    271499.03091 462340.749  70.3%     -    9s
H    0     0                    272525.82819 462340.749  69.7%     -   10s
H    0     0                    272571.94607 462340.749  69.6%     -   12s
H    0     0                    272587.44406 462340.749  69.6%     -   12s
H    0     0                    272674.21736 462340.749  69.6%     -   12s
H    0     0                    272675.14037 462340.749  69.6%     -   13s
     0     0 441859.442    0 2413 272675.140 441859.442  62.0%     -   13s
     0     0 423134.330    0 2125 272675.140 423134.330  55.2%     -   14s
H    0     0                    293505.31463 422917.518  44.1%     -   14s
H    0     0                    299994.30705 422917.518  41.0%     -   14s
H    0     0                    308512.20958 422917.518  37.1%     -   15s
H    0     0                    309968.90972 422917.518  36.4%     -   15s
H    0     0                    317115.77364 422917.518  33.4%     -   15s
H    0     0                    317358.94409 422917.518  33.3%     -   15s
H    0     0                    317481.27586 422917.518  33.2%     -   15s
H    0     0                    317612.72478 422917.518  33.2%     -   15s
H    0     0                    318113.80421 422917.518  32.9%     -   15s
H    0     0                    318367.58490 422917.518  32.8%     -   15s
     0     0 417318.133    0 2060 318367.585 417318.133  31.1%     -   17s
     0     0 407861.851    0 2012 318367.585 407861.851  28.1%     -   18s
     0     0 407820.893    0 2012 318367.585 407820.893  28.1%     -   18s
     0     0 407820.893    0 2012 318367.585 407820.893  28.1%     -   18s
     0     0 407820.893    0 2006 318367.585 407820.893  28.1%     -   18s
H    0     0                    326926.94036 407820.893  24.7%     -   30s
     0     2 407820.893    0 2006 326926.940 407820.893  24.7%     -   32s
    15    32 402947.659    4 2036 326926.940 405086.606  23.9%   457   35s
H   16    32                    330597.05797 405086.606  22.5%   429   35s
   300   361 396690.917   13 1932 330597.058 404422.081  22.3%  52.5   40s
H  548   577                    330597.05803 404422.081  22.3%  35.5   43s
H  608   641                    331817.59510 404422.081  21.9%  33.7   45s
H  611   641                    334674.00652 404422.081  20.8%  33.6   45s
H  617   641                    335020.85177 404422.081  20.7%  33.5   45s
  1070  1145 390625.148   26 1903 335020.852 404422.081  20.7%  25.3   50s
H 1415  1421                    335020.85183 404422.081  20.7%  22.3   53s
  1491  1596 387804.802   36 1891 335020.852 404422.081  20.7%  21.7   55s
  1999  2115 384530.064   44 1889 335020.852 404422.081  20.7%  19.1   60s
  2496  2529 382100.920   54 1863 335020.852 404422.081  20.7%  17.8   65s
H 2500  2529                    335020.85190 404422.081  20.7%  17.8   65s
H 2525  2529                    335020.85207 404422.081  20.7%  17.8   65s
  2948  3117 381208.216   66 1813 335020.852 404422.081  20.7%  16.8   70s
H 3615  3701                    340683.51737 404422.081  18.7%  15.7   76s
H 3622  3701                    341003.09545 404422.081  18.6%  15.6   76s
H 3630  3701                    341056.92357 404422.081  18.6%  15.6   76s
  4068  4288 377438.369   93 1739 341056.924 404422.081  18.6%  14.9   80s
H 4709  4822                    342166.81818 404422.081  18.2%  14.1   85s
H 4711  4822                    342885.11291 404422.081  17.9%  14.1   85s
H 4759  4822                    345297.67854 404422.081  17.1%  14.1   85s
  5295  5554 374868.294  122 1671 345297.679 404422.081  17.1%  13.6   91s
H 5835  5952                    345807.01880 403930.572  16.8%  13.8   95s
H 5849  5933                    346631.40640 403930.572  16.5%  13.8   95s
H 5858  5918                    347522.82315 403930.572  16.2%  13.8   95s
  6092  6277 373084.531  145 1583 347522.823 403930.572  16.2%  13.7  100s
H 6995  7038                    347905.04949 403930.572  16.1%  14.4  107s
H 6996  6985                    349068.10473 403930.572  15.7%  14.4  107s
H 7062  6959                    349402.73738 403930.572  15.6%  14.3  107s
H 7082  6945                    349769.47569 403930.572  15.5%  14.3  107s
  7546  7623 370338.268  179 1455 349769.476 403273.736  15.3%  14.7  112s
  7906  8021 369978.440  191 1422 349769.476 403104.429  15.2%  14.6  115s
H 8304  8256                    349901.58915 403104.429  15.2%  14.3  117s
H 8315  8221                    350370.80563 403104.429  15.1%  14.2  117s
H 8326  8221                    350381.87253 403104.429  15.0%  14.2  117s
H 8349  8197                    350688.50905 403104.429  14.9%  14.2  117s
H 8469  8193                    350744.31527 403104.429  14.9%  14.5  117s
  8542  8562 369156.161  210 1375 350744.315 403104.429  14.9%  14.5  120s
  9376  9446 368248.973  229 1309 350744.315 403104.429  14.9%  14.0  126s
H 9833  8834                    356628.54334 403104.429  13.0%  13.8  129s
H 9838  8689                    357560.66351 403104.429  12.7%  13.8  129s
  9867  9109 367101.716  241 1279 357560.664 403017.341  12.7%  13.9  132s
 10342  9583 366479.091  250 1251 357560.664 403017.341  12.7%  13.9  136s
H11311 10295                    358511.07530 403017.341  12.4%  13.6  143s
H11320 10295                    358527.22150 403017.341  12.4%  13.5  143s
H11363 10293                    358558.51194 403017.341  12.4%  13.5  143s
H11454 10282                    358678.59956 403017.341  12.4%  13.5  143s
H11578 10276                    358721.18679 403017.341  12.3%  13.4  143s
 11698 10811 365770.308  281 1158 358721.187 403017.341  12.3%  13.3  147s
 12233 11412 365349.536  295 1105 358721.187 403017.341  12.3%  13.1  151s
H12834 11813                    358901.42372 403017.341  12.3%  12.8  155s
H12837 11800                    358936.20238 403017.341  12.3%  12.8  155s
H12893 11770                    359200.77545 403017.341  12.2%  12.8  155s
H13049 11770                    359213.11997 403017.341  12.2%  12.7  155s
H13252 11755                    359416.14993 403017.341  12.1%  12.6  155s
 13901 12990 364721.500  331 1038 359416.150 403017.341  12.1%  12.3  163s
H14541 12990                    359416.62632 402833.684  12.1%  12.1  167s
H14541 12869                    360254.90425 402833.684  11.8%  12.1  168s
H14541 12756                    360871.02730 402833.684  11.6%  12.1  168s
 14542 12757 368001.345  278 4941 360871.027 402833.684  11.6%  12.1  174s
H14543 12120                    360872.60668 402833.684  11.6%  12.1  175s
H14546 11515                    360988.05227 402833.684  11.6%  12.1  179s
H14546 10940                    361015.36552 402833.684  11.6%  12.1  180s
H14546 10393                    361146.23032 402833.684  11.5%  12.1  180s
H14546  9873                    361211.51280 402833.684  11.5%  12.1  180s
H14546  9379                    361218.06926 402833.684  11.5%  12.1  180s
 14554  9384 372910.244  171 1158 361218.069 380158.391  5.24%  12.1  185s
 14558  9387 369830.747  134 1127 361218.069 375538.978  3.96%  12.1  190s
 14564  9391 371912.193   14  987 361218.069 371912.193  2.96%  12.1  195s
H14570  8925                    361238.13960 368548.156  2.02%  12.1  200s
H14570  8478                    361260.76547 368548.156  2.02%  12.1  200s
H14570  8054                    361450.17694 368548.156  1.96%  12.1  200s
 14576  8058 362393.892  156  776 361450.177 367154.751  1.58%  12.1  205s
H14584  7659                    361502.43793 365871.281  1.21%  12.1  208s
H14584  7275                    361545.97116 365871.281  1.20%  12.1  208s
H14584  6911                    361658.60314 365871.281  1.16%  12.1  208s
 14587  6913 365775.057  130  653 361658.603 365775.057  1.14%  12.1  210s
 14604  6924 365313.934   36  611 361658.603 365313.934  1.01%  12.1  215s
 14622  6936 364958.150   13  588 361658.603 364958.150  0.91%  12.1  220s
H14636  6597                    361659.05226 364869.056  0.89%  12.0  224s
H14636  6265                    361659.24305 364869.056  0.89%  12.0  224s
H14636  5951                    361792.12470 364869.056  0.85%  12.0  224s
H14636  5652                    361994.13425 364869.056  0.79%  12.0  225s
H14636  5367                    362005.01926 364869.056  0.79%  12.0  225s
H14636  5097                    362075.40312 364869.056  0.77%  12.0  225s
 14650  5107 364824.282  113 5116 362075.403 364824.282  0.76%  15.4  232s
H14651  4852                    362152.47215 364824.282  0.74%  15.4  232s
H14652  4610                    362176.22970 364824.282  0.73%  15.4  233s
H14654  4381                    362176.23685 364824.282  0.73%  15.4  234s
H14654  4161                    362176.27845 364824.282  0.73%  15.4  235s
H14656  3954                    362184.81578 364712.741  0.70%  15.4  238s
 14658  3956 364709.332  134  505 362184.816 364709.332  0.70%  15.4  240s
H14658  3758                    362184.81587 364672.532  0.69%  15.4  240s
H14658  3570                    362202.48817 364672.532  0.68%  15.4  240s
H14658  3391                    362227.86096 364672.532  0.67%  15.4  241s
H14658  3222                    362247.44390 364672.532  0.67%  15.4  241s
 14666  3227 364617.917   37  506 362247.444 364617.917  0.65%  15.4  245s
 14677  3234 364469.991  103  516 362247.444 364469.991  0.61%  15.4  250s
 14689  3242 364242.141   29  469 362247.444 364242.141  0.55%  15.4  255s
 14710  3256 364142.835  169  465 362247.444 364142.835  0.52%  15.3  260s
 14727  3268 364065.144   64  456 362247.444 364065.144  0.50%  15.3  265s
H14730  3105                    362259.31826 364065.036  0.50%  15.3  267s
 14731  3105 364064.917   55  459 362259.318 364064.917  0.50%  15.3  274s
 14732  3107 364064.917   25 3532 362259.318 364064.917  0.50%  17.6  275s
H14733  2952                    362259.71457 364064.917  0.50%  17.6  279s
 14736  2954 364064.917    8 1031 362259.715 364064.917  0.50%  17.5  280s
H14740  2808                    362259.88700 364029.426  0.49%  17.5  283s
H14740  2668                    362299.85444 364029.426  0.48%  17.5  283s
H14740  2534                    362306.31944 364029.426  0.48%  17.5  284s
 14742  2536 364029.426  278  447 362306.319 364029.426  0.48%  17.5  285s
H14749  2413                    362308.20698 363997.890  0.47%  17.5  289s
H14749  2292                    362314.67204 363997.890  0.46%  17.5  289s
 14752  2294 363969.212   34  429 362314.672 363969.212  0.46%  17.5  290s
H14759  2183                    362317.20982 363916.461  0.44%  17.5  294s
 14763  2186 363858.895   46  434 362317.210 363858.895  0.43%  17.5  295s
H14768  2079                    362324.39350 363815.810  0.41%  17.5  298s

Cutting planes:
  Learned: 280
  Gomory: 77
  Cover: 457
  Implied bound: 486
  Projected implied bound: 47
  Clique: 165
  MIR: 783
  Mixing: 3
  StrongCG: 19
  Flow cover: 1203
  GUB cover: 18
  RLT: 2613
  Relax-and-lift: 542
  PSD: 22

Explored 14775 nodes (335025 simplex iterations) in 300.14 seconds (144.59 work units)
Thread count was 32 (of 192 available processors)

Solution count 10: 362324 362324 362317 ... 362259

Time limit reached
Best objective 3.623243934810e+05, best bound 3.637846576922e+05, gap 0.4030%

Solution Summary:
  Total keywords: 1915
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $362,324.39

Results saved to opt_results/bids/optimized_bids_bert_ridge_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_ridge_xgb_2026-01-12_full/optimized_bids_bert_ridge_xgb_lambda_1000p0.csv

Top 10 bids:
                       keyword region        match      bid  predicted_clicks  predicted_epc  conv_value     cost      profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
  generative ai course roadmap      C  Broad match 0.102576         40.744542      87.980466 3584.723809 4.179423 3580.544386            True           NaN           NaN           NaN  1000.0
  generative ai course roadmap      C Phrase match 0.125742         36.044243      94.150346 3393.577952 4.532271 3389.045681            True           NaN           NaN           NaN  1000.0
  generative ai course roadmap      B Phrase match 0.096725         21.253553     105.492792 2242.096631 2.055740 2240.040891            True           NaN           NaN           NaN  1000.0
  generative ai course roadmap      B  Broad match 0.135414         22.241169      99.637191 2216.047606 3.011773 2213.035834            True           NaN           NaN           NaN  1000.0
 generative ai course syllabus      B Phrase match 0.095196         24.043736      75.287732 1810.198372 2.288861 1807.909510            True           NaN           NaN           NaN  1000.0
     generative ai top courses      C  Broad match 0.099040         16.698188      81.156094 1355.159737 1.653781 1353.505956            True           NaN           NaN           NaN  1000.0
                   mit xpro ai    USA  Broad match 0.010000         52.319284      17.505025  915.850363 0.523193  915.327170           False          0.01      2.986893         24.42  1000.0
advanced generative ai courses      B  Broad match 0.127475         10.394593      83.520294  868.159419 1.325053  866.834367            True           NaN           NaN           NaN  1000.0
advanced generative ai courses      C  Broad match 0.101286          8.204414      71.897351  589.875620 0.830992  589.044628            True           NaN           NaN           NaN  1000.0
 intro to generative ai course      C  Broad match 0.103634          8.456967      69.492505  587.695833 0.876428  586.819405            True           NaN           NaN           NaN  1000.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan 12 21:29:18 EST 2026
