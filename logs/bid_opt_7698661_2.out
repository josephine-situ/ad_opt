========== Env & Dir ==========
Host: node1606
Start: Mon Jan  5 11:57:07 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 2 -> lambda=1
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1162 keywords from data/gkp/keywords_classified.csv (new=1001)
Generating BERT embeddings for 1162 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1162, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-05
  Keywords: 1162, Regions: 4, Matches: 3
  Total combinations: 13944
  Using target day for temporal features: 2026-01-05
  Created 13944 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  Loaded 1158 rows from Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  After cleaning: 1156 rows with unique keywords
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             53.27% categorical (Missing)     (n=7428)
  Competition (indexed value)             53.27% numeric (0)               (n=7428)
  Top of page bid (low range)             70.05% numeric (0)               (n=9768)
  Top of page bid (high range)            70.05% numeric (0)               (n=9768)
  last_month_searches                     39.16% numeric (0)               (n=5460)
  three_month_avg                         39.16% numeric (0)               (n=5460)
  six_month_avg                           39.16% numeric (0)               (n=5460)
  mom_change                              39.16% numeric (0)               (n=5460)
  search_trend                            39.16% numeric (0)               (n=5460)
  Avg. CPC                                70.05% numeric (0)               (n=9768)
  -------------------------------------------------------------------------------------
  Total: Imputed 71460 missing values (7.76% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (13944, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_glm_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_glm_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using GLM EPC preprocessor from models/glm_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 5147/13944 rows (dropping 8797 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1401/5147 rows (dropping 3746 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 2635.79)
Saved bid bounds debug CSV: opt_results/cache/bert_glm_xgb_2026-01-05_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded GLM (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1401
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_glm_xgb_2026-01-05_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_glm_xgb_20260105_120118.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9474F 48-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 96 physical cores, 192 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 492231 rows, 462330 columns and 1386831 nonzeros (Max)
Model fingerprint: 0xd79a62ae
Model has 1010 linear objective coefficients
Model has 2802 quadratic objective terms
Model has 1401 quadratic constraints
Model has 5604 simple general constraints
  5604 INDICATOR
Variable types: 36426 continuous, 425904 integer (425904 binary)
Coefficient statistics:
  Matrix range     [7e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [1e+00, 1e+00]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [9e-03, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 454253 rows and 436331 columns
Presolve time: 0.25s
Presolved: 46385 rows, 27402 columns, 101962 nonzeros
Presolved model has 2802 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 12622 continuous, 14780 integer (14780 binary)
Performing another presolve...
Presolve removed 24822 rows and 17078 columns
Presolve time: 0.25s

Root relaxation: objective 1.974207e+05, 7557 iterations, 0.08 seconds (0.09 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 197420.742    0 4912          - 197420.742      -     -    0s
     0     0 197410.601    0 4912          - 197410.601      -     -    0s
     0     0 197371.850    0 4910          - 197371.850      -     -    1s
     0     0 100887.750    0 2723          - 100887.750      -     -    1s
     0     0 83622.6427    0 1553          - 83622.6427      -     -    1s
     0     0 76709.0958    0 1207          - 76709.0958      -     -    1s
     0     0 76053.3437    0  917          - 76053.3437      -     -    2s
     0     0 74661.3927    0  503          - 74661.3927      -     -    2s
     0     0 74453.3425    0  453          - 74453.3425      -     -    2s
     0     0 74163.9577    0  277          - 74163.9577      -     -    2s
H    0     0                    73432.136627 74154.0501  0.98%     -    2s
H    0     0                    73437.217311 74154.0501  0.98%     -    2s
H    0     0                    73464.765231 74154.0501  0.94%     -    3s
H    0     0                    73465.475722 74154.0501  0.94%     -    3s
     0     0 74126.2749    0  251 73465.4757 74126.2749  0.90%     -    3s
     0     0 74052.2568    0  204 73465.4757 74052.2568  0.80%     -    3s
H    0     0                    73465.550224 74048.4699  0.79%     -    3s
     0     0 74037.4098    0  207 73465.5502 74037.4098  0.78%     -    3s
     0     0 74004.2998    0  158 73465.5502 74004.2998  0.73%     -    3s
     0     0 74001.8144    0  152 73465.5502 74001.8144  0.73%     -    4s
     0     0 73991.1817    0  141 73465.5502 73991.1817  0.72%     -    4s
H    0     0                    73557.215598 73990.1652  0.59%     -    4s
     0     0 73990.1652    0  143 73557.2156 73990.1652  0.59%     -    4s
     0     0 73974.8716    0  118 73557.2156 73974.8716  0.57%     -    4s
     0     0 73971.1969    0  116 73557.2156 73971.1969  0.56%     -    4s
     0     0 73970.1928    0  114 73557.2156 73970.1928  0.56%     -    4s
H    0     0                    73568.434851 73970.1928  0.55%     -    6s
     0     0 73967.9212    0  114 73568.4349 73967.9212  0.54%     -    6s
     0     0 73967.9212    0  114 73568.4349 73967.9212  0.54%     -    6s
     0     0 73967.9212    0  114 73568.4349 73967.9212  0.54%     -    6s
H    0     0                    73820.037945 73967.9212  0.20%     -    6s
H    0     0                    73825.597308 73967.9212  0.19%     -    6s
H    0     0                    73836.774504 73967.9212  0.18%     -    6s
H    0     0                    73854.209082 73967.9212  0.15%     -    6s
H    0     0                    73875.567183 73967.9212  0.13%     -    7s
H    0     0                    73879.023825 73967.9212  0.12%     -    7s
H    0     0                    73885.322644 73967.9212  0.11%     -    7s
H    0     0                    73890.637908 73967.9212  0.10%     -    7s
H    0     0                    73900.188337 73967.9212  0.09%     -    7s
H    0     0                    73906.072242 73967.9212  0.08%     -    7s
H    0     0                    73906.719649 73967.9212  0.08%     -    7s
     0     0 73967.9212    0 2167 73906.7196 73967.9212  0.08%     -    8s
     0     0 73967.9212    0 2211 73906.7196 73967.9212  0.08%     -    8s
     0     0 73967.9212    0 2212 73906.7196 73967.9212  0.08%     -    8s
     0     0 73967.9212    0 1073 73906.7196 73967.9212  0.08%     -    9s
     0     0 73967.9212    0  179 73906.7196 73967.9212  0.08%     -    9s
     0     0 73961.1007    0  106 73906.7196 73961.1007  0.07%     -    9s
     0     0 73961.0841    0  106 73906.7196 73961.0841  0.07%     -    9s
     0     0 73952.6979    0   91 73906.7196 73952.6979  0.06%     -    9s
     0     0 73952.6578    0   92 73906.7196 73952.6578  0.06%     -    9s
     0     0 73930.8578    0   51 73906.7196 73930.8578  0.03%     -    9s
     0     0 73930.8578    0   51 73906.7196 73930.8578  0.03%     -    9s
     0     0 73927.1089    0   41 73906.7196 73927.1089  0.03%     -    9s
     0     0 73927.1089    0   41 73906.7196 73927.1089  0.03%     -    9s
     0     0 73918.9571    0   31 73906.7196 73918.9571  0.02%     -    9s
     0     0 73918.9571    0 1066 73906.7196 73918.9571  0.02%     -    9s
     0     0 73918.9571    0 1053 73906.7196 73918.9571  0.02%     -   10s
     0     0 73918.9571    0 1055 73906.7196 73918.9571  0.02%     -   10s
     0     0 73918.9571    0  180 73906.7196 73918.9571  0.02%     -   10s
     0     0 73918.9571    0   40 73906.7196 73918.9571  0.02%     -   10s
     0     0 73918.9571    0   40 73906.7196 73918.9571  0.02%     -   10s
     0     0 73917.4214    0   27 73906.7196 73917.4214  0.01%     -   10s
     0     0 73917.4214    0   27 73906.7196 73917.4214  0.01%     -   10s
     0     0 73916.6839    0   21 73906.7196 73916.6839  0.01%     -   10s

Cutting planes:
  Learned: 95
  Gomory: 47
  Cover: 8
  Implied bound: 127
  MIR: 272
  Flow cover: 30
  RLT: 703
  Relax-and-lift: 72
  BQP: 1

Explored 1 nodes (39104 simplex iterations) in 10.94 seconds (7.22 work units)
Thread count was 32 (of 192 available processors)

Solution count 10: 73911.3 73906.7 73906.1 ... 73836.8

Optimal solution found (tolerance 1.00e-04)
Best objective 7.391134021912e+04, best bound 7.391668392989e+04, gap 0.0072%

Solution Summary:
  Total keywords: 1401
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $73,911.34

Results saved to opt_results/bids/optimized_bids_bert_glm_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_glm_xgb_2026-01-05_full/optimized_bids_bert_glm_xgb_lambda_1p0.csv

Top 10 bids:
                         keyword region       match      bid  predicted_clicks  predicted_epc  conv_value     cost     profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
       top generative ai courses      C Broad match 0.100007         11.961635      83.051025  993.426011 1.196250 992.229761            True           NaN           NaN           NaN     1.0
       top generative ai courses      A Broad match 0.410000          7.720444      98.732496  762.258745 3.165382 759.093363            True           NaN           NaN           NaN     1.0
       top generative ai courses    USA Broad match 0.716445          8.594504      82.826110  711.849357 6.157486 705.691871            True           NaN           NaN           NaN     1.0
       top generative ai courses      B Broad match 0.125862          6.696769     100.590011  673.628089 0.842868 672.785221            True           NaN           NaN           NaN     1.0
       generative ai top courses      B Broad match 0.260000          6.436606      89.913790  578.739624 1.673518 577.066107            True           NaN           NaN           NaN     1.0
       generative ai top courses      C Broad match 0.099538          7.926447      71.613682  567.642031 0.788982 566.853049            True           NaN           NaN           NaN     1.0
top generative ai courses online      C Broad match 0.123043         12.340650      45.996077  567.621490 1.518435 566.103056            True           NaN           NaN           NaN     1.0
 generative ai course curriculum      B Broad match 0.420000          6.791550      83.730113  568.657251 2.852451 565.804800            True           NaN           NaN           NaN     1.0
 generative ai course curriculum      C Broad match 0.103915          8.241382      64.550050  531.981626 0.856401 531.125225            True           NaN           NaN           NaN     1.0
           ai generative courses      C Broad match 0.100965          9.580808      55.456876  531.321689 0.967331 530.354358            True           NaN           NaN           NaN     1.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan  5 12:01:32 EST 2026
