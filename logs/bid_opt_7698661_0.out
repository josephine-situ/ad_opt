========== Env & Dir ==========
Host: node1612
Start: Mon Jan  5 11:57:07 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 0 -> lambda=-1
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1162 keywords from data/gkp/keywords_classified.csv (new=1001)
Generating BERT embeddings for 1162 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1162, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-05
  Keywords: 1162, Regions: 4, Matches: 3
  Total combinations: 13944
  Using target day for temporal features: 2026-01-05
  Created 13944 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  Loaded 1158 rows from Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  After cleaning: 1156 rows with unique keywords
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             53.27% categorical (Missing)     (n=7428)
  Competition (indexed value)             53.27% numeric (0)               (n=7428)
  Top of page bid (low range)             70.05% numeric (0)               (n=9768)
  Top of page bid (high range)            70.05% numeric (0)               (n=9768)
  last_month_searches                     39.16% numeric (0)               (n=5460)
  three_month_avg                         39.16% numeric (0)               (n=5460)
  six_month_avg                           39.16% numeric (0)               (n=5460)
  mom_change                              39.16% numeric (0)               (n=5460)
  search_trend                            39.16% numeric (0)               (n=5460)
  Avg. CPC                                70.05% numeric (0)               (n=9768)
  -------------------------------------------------------------------------------------
  Total: Imputed 71460 missing values (7.76% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (13944, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_glm_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_glm_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using GLM EPC preprocessor from models/glm_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 5147/13944 rows (dropping 8797 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1401/5147 rows (dropping 3746 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 2635.79)
Saved bid bounds debug CSV: opt_results/cache/bert_glm_xgb_2026-01-05_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded GLM (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1401
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_glm_xgb_2026-01-05_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_glm_xgb_20260105_115934.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9474F 48-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 96 physical cores, 192 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 492231 rows, 462330 columns and 1386831 nonzeros (Max)
Model fingerprint: 0x342c27e7
Model has 1010 linear objective coefficients
Model has 2802 quadratic objective terms
Model has 1401 quadratic constraints
Model has 5604 simple general constraints
  5604 INDICATOR
Variable types: 36426 continuous, 425904 integer (425904 binary)
Coefficient statistics:
  Matrix range     [7e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [1e+00, 1e+00]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [9e-03, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 454253 rows and 436331 columns
Presolve time: 0.25s
Presolved: 46385 rows, 27402 columns, 101962 nonzeros
Presolved model has 2802 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 12622 continuous, 14780 integer (14780 binary)
Performing another presolve...
Presolve removed 24822 rows and 17078 columns
Presolve time: 0.26s

Root relaxation: objective 1.916210e+05, 6813 iterations, 0.07 seconds (0.09 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 191620.960    0 4882          - 191620.960      -     -    1s
     0     0 191611.157    0 4882          - 191611.157      -     -    1s
     0     0 191573.328    0 4880          - 191573.328      -     -    1s
     0     0 99319.6558    0 2671          - 99319.6558      -     -    1s
     0     0 82698.9063    0 1466          - 82698.9063      -     -    2s
     0     0 75870.2814    0 1046          - 75870.2814      -     -    2s
     0     0 75180.6326    0  761          - 75180.6326      -     -    2s
     0     0 74325.2384    0  352          - 74325.2384      -     -    2s
H    0     0                    73024.954605 74314.4108  1.77%     -    2s
     0     0 74155.2918    0  351 73024.9546 74155.2918  1.55%     -    2s
     0     0 73933.6499    0  194 73024.9546 73933.6499  1.24%     -    3s
H    0     0                    73564.854706 73931.5384  0.50%     -    3s
H    0     0                    73586.320510 73931.5384  0.47%     -    3s
H    0     0                    73586.618481 73931.5384  0.47%     -    3s
     0     0 73887.8100    0  200 73586.6185 73887.8100  0.41%     -    3s
     0     0 73887.7703    0  197 73586.6185 73887.7703  0.41%     -    3s
     0     0 73841.0171    0  181 73586.6185 73841.0171  0.35%     -    3s
     0     0 73841.0171    0  181 73586.6185 73841.0171  0.35%     -    3s
H    0     0                    73606.886273 73841.0171  0.32%     -    6s
     0     0 73840.1744    0  180 73606.8863 73840.1744  0.32%     -    6s
     0     0 73840.1744    0  180 73606.8863 73840.1744  0.32%     -    6s
     0     0 73840.1744    0  180 73606.8863 73840.1744  0.32%     -    6s
H    0     0                    73614.661264 73838.9116  0.30%     -    6s
H    0     0                    73629.459773 73838.9116  0.28%     -    6s
H    0     0                    73630.884748 73838.9116  0.28%     -    6s
H    0     0                    73637.410013 73838.9116  0.27%     -    6s
H    0     0                    73643.669388 73838.9116  0.27%     -    6s
H    0     0                    73643.792154 73838.9116  0.26%     -    6s
H    0     0                    73709.861022 73838.9116  0.18%     -    6s
     0     0 73838.9116    0 2642 73709.8610 73838.9116  0.18%     -    7s
     0     0 73838.9116    0 2630 73709.8610 73838.9116  0.18%     -    7s
     0     0 73838.9116    0 2631 73709.8610 73838.9116  0.18%     -    7s
     0     0 73838.9116    0 1305 73709.8610 73838.9116  0.18%     -    8s
     0     0 73838.9116    0  237 73709.8610 73838.9116  0.18%     -    8s
     0     0 73808.0568    0  141 73709.8610 73808.0568  0.13%     -    8s
     0     0 73808.0568    0  141 73709.8610 73808.0568  0.13%     -    8s
     0     0 73791.2970    0  132 73709.8610 73791.2970  0.11%     -    8s
     0     0 73789.4228    0  129 73709.8610 73789.4228  0.11%     -    8s
     0     0 73744.9586    0   51 73709.8610 73744.9586  0.05%     -    8s
     0     0 73742.0457    0   49 73709.8610 73742.0457  0.04%     -    8s
     0     0 73738.5554    0   44 73709.8610 73738.5554  0.04%     -    8s
     0     0 73738.5554    0   44 73709.8610 73738.5554  0.04%     -    8s
     0     0 73733.4151    0   32 73709.8610 73733.4151  0.03%     -    8s
     0     0 73733.4151    0 1398 73709.8610 73733.4151  0.03%     -    9s
     0     0 73733.4151    0 1434 73709.8610 73733.4151  0.03%     -    9s
     0     0 73733.4151    0 1434 73709.8610 73733.4151  0.03%     -    9s
     0     0 73733.4151    0  415 73709.8610 73733.4151  0.03%     -   10s
     0     0 73733.4151    0   51 73709.8610 73733.4151  0.03%     -   10s
     0     0 73727.4833    0   25 73709.8610 73727.4833  0.02%     -   10s
     0     0 73727.4833    0   25 73709.8610 73727.4833  0.02%     -   10s
     0     0 73725.8756    0   21 73709.8610 73725.8756  0.02%     -   10s
     0     0 73725.3570    0   20 73709.8610 73725.3570  0.02%     -   10s
     0     0 73724.0828    0   21 73709.8610 73724.0828  0.02%     -   10s
     0     0 73721.6825    0   16 73709.8610 73721.6825  0.02%     -   10s
     0     0 73721.6825    0   16 73709.8610 73721.6825  0.02%     -   10s
     0     0 73721.0113    0   16 73709.8610 73721.0113  0.02%     -   10s
     0     0 73721.0113    0   16 73709.8610 73721.0113  0.02%     -   10s
     0     0 73720.9656    0   17 73709.8610 73720.9656  0.02%     -   10s
     0     0 73720.9656    0   17 73709.8610 73720.9656  0.02%     -   10s
     0     0 73720.9537    0   15 73709.8610 73720.9537  0.02%     -   10s
     0     0 73720.9537    0  870 73709.8610 73720.9537  0.02%     -   11s
     0     0 73720.9537    0  873 73709.8610 73720.9537  0.02%     -   11s
     0     0 73720.9537    0   86 73709.8610 73720.9537  0.02%     -   11s
     0     0 73720.9537    0   30 73709.8610 73720.9537  0.02%     -   11s
     0     0 73720.9537    0    9 73709.8610 73720.9537  0.02%     -   11s
     0     0 73719.3856    0    9 73709.8610 73719.3856  0.01%     -   11s
     0     0 73719.3856    0    9 73709.8610 73719.3856  0.01%     -   11s
     0     0 73719.1976    0    6 73709.8610 73719.1976  0.01%     -   11s
     0     0 73719.1976    0    6 73709.8610 73719.1976  0.01%     -   11s
     0     0 73719.1785    0    6 73709.8610 73719.1785  0.01%     -   11s
     0     0 73719.1785    0    6 73709.8610 73719.1785  0.01%     -   12s
     0     0 73719.1785    0    6 73709.8610 73719.1785  0.01%     -   12s
H    0     0                    73710.613714 73719.1785  0.01%     -   12s
H    0     2                    73710.614807 73719.1785  0.01%     -   12s
     0     2 73719.1785    0    6 73710.6148 73719.1785  0.01%     -   12s
H    4     7                    73717.199722 73718.9780  0.00%   5.2   12s

Cutting planes:
  Learned: 76
  Gomory: 44
  Cover: 5
  Implied bound: 109
  MIR: 258
  Flow cover: 23
  RLT: 624
  Relax-and-lift: 51

Explored 7 nodes (42744 simplex iterations) in 12.60 seconds (8.32 work units)
Thread count was 32 (of 192 available processors)

Solution count 10: 73717.2 73710.6 73710.6 ... 73637.4

Optimal solution found (tolerance 1.00e-04)
Best objective 7.371719972176e+04, best bound 7.371884664214e+04, gap 0.0022%

Solution Summary:
  Total keywords: 1401
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $73,717.20

Results saved to opt_results/bids/optimized_bids_bert_glm_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_glm_xgb_2026-01-05_full/optimized_bids_bert_glm_xgb_lambda_m1p0.csv

Top 10 bids:
                         keyword region       match      bid  predicted_clicks  predicted_epc  conv_value     cost     profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
       top generative ai courses      C Broad match 0.100007         11.961635      83.051025  993.426011 1.196250 992.229761            True           NaN           NaN           NaN    -1.0
       top generative ai courses      A Broad match 0.410000          7.720444      98.732496  762.258745 3.165382 759.093363            True           NaN           NaN           NaN    -1.0
       top generative ai courses    USA Broad match 0.716445          8.594504      82.826110  711.849357 6.157486 705.691871            True           NaN           NaN           NaN    -1.0
       top generative ai courses      B Broad match 0.125862          6.696769     100.590011  673.628089 0.842868 672.785221            True           NaN           NaN           NaN    -1.0
       generative ai top courses      B Broad match 0.260000          6.436606      89.913790  578.739624 1.673518 577.066107            True           NaN           NaN           NaN    -1.0
       generative ai top courses      C Broad match 0.099538          7.926447      71.613682  567.642031 0.788982 566.853049            True           NaN           NaN           NaN    -1.0
top generative ai courses online      C Broad match 0.123043         12.340650      45.996077  567.621490 1.518435 566.103056            True           NaN           NaN           NaN    -1.0
 generative ai course curriculum      B Broad match 0.420000          6.791550      83.730113  568.657251 2.852451 565.804800            True           NaN           NaN           NaN    -1.0
 generative ai course curriculum      C Broad match 0.103915          8.241382      64.550050  531.981626 0.856401 531.125225            True           NaN           NaN           NaN    -1.0
           ai generative courses      C Broad match 0.100965          9.580808      55.456876  531.321689 0.967331 530.354358            True           NaN           NaN           NaN    -1.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan  5 11:59:50 EST 2026
