========== Env & Dir ==========
Host: node2704
Start: Mon Jan  5 11:57:07 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 3 -> lambda=2
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1162 keywords from data/gkp/keywords_classified.csv (new=1001)
Generating BERT embeddings for 1162 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1162, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-05
  Keywords: 1162, Regions: 4, Matches: 3
  Total combinations: 13944
  Using target day for temporal features: 2026-01-05
  Created 13944 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  Loaded 1158 rows from Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  After cleaning: 1156 rows with unique keywords
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             53.27% categorical (Missing)     (n=7428)
  Competition (indexed value)             53.27% numeric (0)               (n=7428)
  Top of page bid (low range)             70.05% numeric (0)               (n=9768)
  Top of page bid (high range)            70.05% numeric (0)               (n=9768)
  last_month_searches                     39.16% numeric (0)               (n=5460)
  three_month_avg                         39.16% numeric (0)               (n=5460)
  six_month_avg                           39.16% numeric (0)               (n=5460)
  mom_change                              39.16% numeric (0)               (n=5460)
  search_trend                            39.16% numeric (0)               (n=5460)
  Avg. CPC                                70.05% numeric (0)               (n=9768)
  -------------------------------------------------------------------------------------
  Total: Imputed 71460 missing values (7.76% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (13944, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_glm_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_glm_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using GLM EPC preprocessor from models/glm_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 5147/13944 rows (dropping 8797 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1401/5147 rows (dropping 3746 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 2635.79)
Saved bid bounds debug CSV: opt_results/cache/bert_glm_xgb_2026-01-05_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded GLM (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1401
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_glm_xgb_2026-01-05_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_glm_xgb_20260105_120025.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9384X 32-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 64 physical cores, 128 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 492231 rows, 462330 columns and 1386831 nonzeros (Max)
Model fingerprint: 0x7101e56f
Model has 1010 linear objective coefficients
Model has 2802 quadratic objective terms
Model has 1401 quadratic constraints
Model has 5604 simple general constraints
  5604 INDICATOR
Variable types: 36426 continuous, 425904 integer (425904 binary)
Coefficient statistics:
  Matrix range     [7e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [2e+00, 2e+00]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [9e-03, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 454253 rows and 436331 columns
Presolve time: 0.23s
Presolved: 46385 rows, 27402 columns, 101962 nonzeros
Presolved model has 2802 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 12622 continuous, 14780 integer (14780 binary)
Performing another presolve...
Presolve removed 24822 rows and 17078 columns
Presolve time: 0.97s

Root relaxation: objective 2.003385e+05, 7646 iterations, 0.09 seconds (0.10 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 200338.484    0 4920          - 200338.484      -     -    1s
     0     0 200328.757    0 4920          - 200328.757      -     -    1s
     0     0 200291.617    0 4918          - 200291.617      -     -    1s
     0     0 101989.440    0 2755          - 101989.440      -     -    3s
     0     0 84374.5240    0 1599          - 84374.5240      -     -    3s
     0     0 77064.4293    0 1269          - 77064.4293      -     -    3s
     0     0 76297.5318    0  986          - 76297.5318      -     -    3s
     0     0 74805.8371    0  519          - 74805.8371      -     -    4s
     0     0 74580.7387    0  451          - 74580.7387      -     -    4s
     0     0 74267.2587    0  276          - 74267.2587      -     -    4s
H    0     0                    73632.344527 74264.4428  0.86%     -    4s
H    0     0                    73636.105852 74264.4428  0.85%     -    4s
H    0     0                    73641.139589 74264.4428  0.85%     -    4s
H    0     0                    73654.025347 74264.4428  0.83%     -    4s
H    0     0                    73668.038937 74264.4428  0.81%     -    4s
H    0     0                    73705.012323 74264.4428  0.76%     -    4s
H    0     0                    73726.083867 74264.4428  0.73%     -    4s
     0     0 74227.0179    0  249 73726.0839 74227.0179  0.68%     -    5s
     0     0 74151.6532    0  206 73726.0839 74151.6532  0.58%     -    5s
     0     0 74140.5507    0  200 73726.0839 74140.5507  0.56%     -    5s
     0     0 74113.6752    0  159 73726.0839 74113.6752  0.53%     -    6s
     0     0 74105.2828    0  161 73726.0839 74105.2828  0.51%     -    6s
     0     0 74105.2776    0  160 73726.0839 74105.2776  0.51%     -    6s
     0     0 74090.0260    0  127 73726.0839 74090.0260  0.49%     -    7s
     0     0 74090.0185    0  125 73726.0839 74090.0185  0.49%     -    7s
H    0     0                    73761.474427 74086.2872  0.44%     -    7s
     0     0 74083.8457    0  124 73761.4744 74083.8457  0.44%     -    7s
     0     0 74075.9385    0  115 73761.4744 74075.9385  0.43%     -    7s
     0     0 74073.4444    0  115 73761.4744 74073.4444  0.42%     -    9s
     0     0 74073.4444    0  115 73761.4744 74073.4444  0.42%     -    9s
     0     0 74073.4444    0  115 73761.4744 74073.4444  0.42%     -    9s
H    0     0                    73921.549022 74073.4444  0.21%     -    9s
H    0     0                    73955.280273 74073.4444  0.16%     -   10s
H    0     0                    73956.039344 74073.4444  0.16%     -   10s
H    0     0                    73971.877643 74073.4444  0.14%     -   10s
H    0     0                    73972.010047 74073.4444  0.14%     -   10s
H    0     0                    74011.788644 74073.4444  0.08%     -   10s
     0     0 74073.4444    0 2185 74011.7886 74073.4444  0.08%     -   11s
     0     0 74073.4444    0 2229 74011.7886 74073.4444  0.08%     -   11s
     0     0 74073.4444    0 2226 74011.7886 74073.4444  0.08%     -   11s
     0     0 74073.4444    0 1080 74011.7886 74073.4444  0.08%     -   13s
     0     0 74073.4444    0  169 74011.7886 74073.4444  0.08%     -   13s
     0     0 74066.1676    0   92 74011.7886 74066.1676  0.07%     -   13s
     0     0 74066.1510    0   92 74011.7886 74066.1510  0.07%     -   13s
     0     0 74053.6242    0   81 74011.7886 74053.6242  0.06%     -   13s
     0     0 74053.5185    0   81 74011.7886 74053.5185  0.06%     -   13s
     0     0 74021.8336    0   44 74011.7886 74021.8336  0.01%     -   13s
     0     0 74020.8663    0   43 74011.7886 74020.8663  0.01%     -   13s
     0     0 74019.8564    0   38 74011.7886 74019.8564  0.01%     -   13s
     0     0          -    0      74011.7886 74018.9641  0.01%     -   13s

Cutting planes:
  Learned: 154
  Gomory: 27
  Cover: 34
  Implied bound: 257
  Clique: 4
  MIR: 440
  StrongCG: 1
  Flow cover: 27
  RLT: 1428
  Relax-and-lift: 184

Explored 1 nodes (34733 simplex iterations) in 13.67 seconds (6.88 work units)
Thread count was 32 (of 128 available processors)

Solution count 10: 74011.8 73972 73971.9 ... 73668

Optimal solution found (tolerance 1.00e-04)
Best objective 7.401178864431e+04, best bound 7.401896407851e+04, gap 0.0097%

Solution Summary:
  Total keywords: 1401
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $74,011.79

Results saved to opt_results/bids/optimized_bids_bert_glm_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_glm_xgb_2026-01-05_full/optimized_bids_bert_glm_xgb_lambda_2p0.csv

Top 10 bids:
                         keyword region       match      bid  predicted_clicks  predicted_epc  conv_value     cost     profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
       top generative ai courses      C Broad match 0.100007         11.961635      83.051025  993.426011 1.196250 992.229761            True           NaN           NaN           NaN     2.0
       top generative ai courses      A Broad match 0.410000          7.720444      98.732496  762.258745 3.165382 759.093363            True           NaN           NaN           NaN     2.0
       top generative ai courses    USA Broad match 0.716445          8.594504      82.826110  711.849357 6.157486 705.691871            True           NaN           NaN           NaN     2.0
       top generative ai courses      B Broad match 0.125862          6.696769     100.590011  673.628089 0.842868 672.785221            True           NaN           NaN           NaN     2.0
       generative ai top courses      B Broad match 0.260000          6.436606      89.913790  578.739624 1.673518 577.066107            True           NaN           NaN           NaN     2.0
       generative ai top courses      C Broad match 0.099538          7.926447      71.613682  567.642031 0.788982 566.853049            True           NaN           NaN           NaN     2.0
top generative ai courses online      C Broad match 0.123043         12.340650      45.996077  567.621490 1.518435 566.103056            True           NaN           NaN           NaN     2.0
 generative ai course curriculum      B Broad match 0.420000          6.791550      83.730113  568.657251 2.852451 565.804800            True           NaN           NaN           NaN     2.0
 generative ai course curriculum      C Broad match 0.103915          8.241382      64.550050  531.981626 0.856401 531.125225            True           NaN           NaN           NaN     2.0
           ai generative courses      C Broad match 0.100965          9.580808      55.456876  531.321689 0.967331 530.354358            True           NaN           NaN           NaN     2.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan  5 12:00:42 EST 2026
