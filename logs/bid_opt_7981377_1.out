========== Env & Dir ==========
Host: node1603
Start: Mon Jan 12 21:20:35 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 1 -> lambda=10
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1798 keywords from data/gkp/keywords_classified.csv (new=995)
Generating BERT embeddings for 1798 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1798, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-12
  Keywords: 1798, Regions: 4, Matches: 3
  Total combinations: 21576
  Using target day for temporal features: 2026-01-12
  Created 21576 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  Loaded 1749 rows from Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  After cleaning: 1747 rows with unique keywords
  Fuzzy-matched 468 rows using similar-word normalization
  Example fuzzy mappings: ['advanced generative ai courses -> advanced generative ai course', 'ai certification -> artificial intelligence certification', 'ai certification courses -> ai certificate course', 'ai courses -> artificial intelligence course', 'ai for engineers -> ai for engineering']
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             37.99% categorical (Missing)     (n=8196)
  Competition (indexed value)             37.99% numeric (0)               (n=8196)
  Top of page bid (low range)             54.12% numeric (0)               (n=11676)
  Top of page bid (high range)            54.12% numeric (0)               (n=11676)
  _kw_key                                 71.19% categorical (Missing)     (n=15360)
  last_month_searches                     26.64% numeric (0)               (n=5748)
  three_month_avg                         26.64% numeric (0)               (n=5748)
  six_month_avg                           26.64% numeric (0)               (n=5748)
  mom_change                              26.64% numeric (0)               (n=5748)
  search_trend                            26.64% numeric (0)               (n=5748)
  Avg. CPC                                54.12% numeric (0)               (n=11676)
  -------------------------------------------------------------------------------------
  Total: Imputed 95520 missing values (6.61% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (21576, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_ridge_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_ridge_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using Ridge EPC preprocessor from models/ridge_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 9104/21576 rows (dropping 12472 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1915/9104 rows (dropping 7189 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 745347.56)
Loading embeddings from data/clean/unique_keyword_embeddings_bert.csv...
  Loaded 154 rows with complete embeddings
Saved bid bounds debug CSV: opt_results/cache/bert_ridge_xgb_2026-01-12_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded RIDGE (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1915
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_ridge_xgb_2026-01-12_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_ridge_xgb_20260112_213518.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9474F 48-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 96 physical cores, 192 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 759520 rows, 653015 columns and 2096428 nonzeros (Max)
Model fingerprint: 0x5493040e
Model has 1155 linear objective coefficients
Model has 3830 quadratic objective terms
Model has 1915 quadratic constraints
Model has 7660 simple general constraints
  7660 INDICATOR
Variable types: 49790 continuous, 603225 integer (603225 binary)
Coefficient statistics:
  Matrix range     [5e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [1e+01, 1e+01]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [3e-02, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 683480 rows and 603795 columns
Presolve time: 0.58s
Presolved: 87531 rows, 51137 columns, 201419 nonzeros
Presolved model has 3830 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 20629 continuous, 30508 integer (30508 binary)
Performing another presolve...
Presolve removed 52223 rows and 30633 columns
Presolve time: 0.93s
Deterministic concurrent LP optimizer: primal and dual simplex
Showing primal log only...

Concurrent spin time: 0.01s

Solved with dual simplex

Root relaxation: objective 5.422321e+05, 12296 iterations, 0.27 seconds (0.24 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 542232.149    0 8442          - 542232.149      -     -    2s
     0     0 538060.520    0 8427          - 538060.520      -     -    2s
     0     0 534122.534    0 8423          - 534122.534      -     -    3s
     0     0 531558.571    0 8428          - 531558.571      -     -    3s
     0     0 528467.100    0 8431          - 528467.100      -     -    3s
     0     0 243755.447    0 6007          - 243755.447      -     -    6s
     0     0 214871.151    0 3843          - 214871.151      -     -    7s
     0     0 182101.495    0 2694          - 182101.495      -     -    8s
     0     0 170345.132    0 2159          - 170345.132      -     -    8s
     0     0 163768.114    0 1649          - 163768.114      -     -   11s
     0     0 162021.113    0 1673          - 162021.113      -     -   11s
     0     0 159955.816    0 1167          - 159955.816      -     -   13s
H    0     0                    153065.02719 159944.959  4.49%     -   13s
H    0     0                    153804.58117 159944.959  3.99%     -   14s
H    0     0                    153810.08417 159944.959  3.99%     -   14s
H    0     0                    153853.16255 159944.959  3.96%     -   15s
H    0     0                    153853.36034 159944.959  3.96%     -   15s
H    0     0                    153854.25804 159944.959  3.96%     -   15s
H    0     0                    153860.36877 159944.959  3.95%     -   16s
H    0     0                    153861.28449 159944.959  3.95%     -   16s
H    0     0                    153882.27028 159944.959  3.94%     -   17s
H    0     0                    153888.90462 159944.959  3.94%     -   17s
H    0     0                    153895.22174 159944.959  3.93%     -   17s
     0     0 159667.910    0 1135 153895.222 159667.910  3.75%     -   17s
     0     0 159105.755    0  966 153895.222 159105.755  3.39%     -   18s
H    0     0                    157242.50909 159102.286  1.18%     -   18s
H    0     0                    157330.19134 159102.286  1.13%     -   18s
H    0     0                    157781.59585 159102.286  0.84%     -   18s
H    0     0                    157796.11979 159102.286  0.83%     -   18s
H    0     0                    157973.61243 159102.286  0.71%     -   18s
H    0     0                    158038.39340 159102.286  0.67%     -   18s
H    0     0                    158043.85732 159102.286  0.67%     -   18s
     0     0 159034.663    0  916 158043.857 159034.663  0.63%     -   19s
     0     0 159034.663    0  916 158043.857 159034.663  0.63%     -   19s
     0     0 158819.525    0  749 158043.857 158819.525  0.49%     -   20s
     0     0 158819.525    0  749 158043.857 158819.525  0.49%     -   20s
     0     0 158787.396    0  762 158043.857 158787.396  0.47%     -   20s
     0     0 158707.954    0  650 158043.857 158707.954  0.42%     -   21s
     0     0 158707.942    0  649 158043.857 158707.942  0.42%     -   21s
H    0     0                    158047.55489 158694.489  0.41%     -   22s
H    0     0                    158049.45688 158694.489  0.41%     -   22s
H    0     0                    158054.30252 158694.489  0.41%     -   22s
H    0     0                    158065.82687 158694.489  0.40%     -   22s
H    0     0                    158069.74112 158694.489  0.40%     -   22s
     0     0 158690.318    0  640 158069.741 158690.318  0.39%     -   22s
     0     0 158690.216    0  639 158069.741 158690.216  0.39%     -   22s
     0     0 158670.463    0  618 158069.741 158670.463  0.38%     -   24s
     0     0 158670.463    0 5705 158069.741 158670.463  0.38%     -   26s
     0     0 158670.463    0 5679 158069.741 158670.463  0.38%     -   26s
     0     0 158670.463    0 5683 158069.741 158670.463  0.38%     -   26s
     0     0 158670.463    0 5683 158069.741 158670.463  0.38%     -   26s
     0     0 158670.463    0 3259 158069.741 158670.463  0.38%     -   27s
     0     0 158670.463    0 1241 158069.741 158670.463  0.38%     -   27s
     0     0 158670.463    0  609 158069.741 158670.463  0.38%     -   28s
     0     0 158670.463    0  507 158069.741 158670.463  0.38%     -   28s
     0     0 158449.722    0  378 158069.741 158449.722  0.24%     -   29s
     0     0 158449.478    0  377 158069.741 158449.478  0.24%     -   29s
H    0     0                    158070.64189 158438.543  0.23%     -   29s
H    0     0                    158073.66917 158438.543  0.23%     -   29s
H    0     0                    158074.02966 158438.543  0.23%     -   29s
     0     0 158390.913    0  385 158074.030 158390.913  0.20%     -   29s
     0     0 158390.293    0  382 158074.030 158390.293  0.20%     -   30s
     0     0 158301.926    0  297 158074.030 158301.926  0.14%     -   30s
     0     0 158301.754    0  292 158074.030 158301.754  0.14%     -   30s
     0     0 158285.850    0  288 158074.030 158285.850  0.13%     -   31s
     0     0 158285.850    0  283 158074.030 158285.850  0.13%     -   31s
     0     0 158279.888    0  263 158074.030 158279.888  0.13%     -   31s
     0     0 158279.888    0 3805 158074.030 158279.888  0.13%     -   32s
     0     0 158279.888    0 3873 158074.030 158279.888  0.13%     -   32s
     0     0 158279.888    0 3870 158074.030 158279.888  0.13%     -   32s
     0     0 158279.888    0 1992 158074.030 158279.888  0.13%     -   33s
     0     0 158279.888    0  667 158074.030 158279.888  0.13%     -   33s
     0     0 158279.888    0  252 158074.030 158279.888  0.13%     -   33s
     0     0 158279.888    0  237 158074.030 158279.888  0.13%     -   34s
     0     0 158236.267    0  224 158074.030 158236.267  0.10%     -   34s
     0     0 158236.267    0  224 158074.030 158236.267  0.10%     -   34s
H    0     0                    158074.32705 158236.267  0.10%     -   37s
     0     0 158231.450    0  200 158074.327 158231.450  0.10%     -   37s
     0     0 158231.450    0  200 158074.327 158231.450  0.10%     -   37s
     0     0 158231.450    0  200 158074.327 158231.450  0.10%     -   37s
H    0     0                    158078.16318 158225.873  0.09%     -   38s
H    0     0                    158079.94803 158225.873  0.09%     -   38s
H    0     0                    158082.37699 158225.873  0.09%     -   38s
H    0     0                    158088.26624 158225.873  0.09%     -   39s
     0     0 158225.872    0 3090 158088.266 158225.872  0.09%     -   41s
     0     0 158225.872    0 3100 158088.266 158225.872  0.09%     -   41s
     0     0 158225.872    0 3099 158088.266 158225.872  0.09%     -   41s
     0     0 158225.872    0 1445 158088.266 158225.872  0.09%     -   42s
     0     0 158225.872    0  249 158088.266 158225.872  0.09%     -   42s
     0     0 158225.872    0  157 158088.266 158225.872  0.09%     -   42s
     0     0 158225.872    0  156 158088.266 158225.872  0.09%     -   42s
     0     0 158200.170    0  144 158088.266 158200.170  0.07%     -   42s
     0     0 158200.170    0  144 158088.266 158200.170  0.07%     -   42s
     0     0 158167.186    0  121 158088.266 158167.186  0.05%     -   42s
     0     0 158167.186    0  121 158088.266 158167.186  0.05%     -   42s
     0     0 158160.805    0  116 158088.266 158160.805  0.05%     -   42s
     0     0 158147.735    0  111 158088.266 158147.735  0.04%     -   43s
     0     0 158147.332    0  115 158088.266 158147.332  0.04%     -   44s
     0     0 158147.332    0 1938 158088.266 158147.332  0.04%     -   45s
     0     0 158147.332    0 1934 158088.266 158147.332  0.04%     -   45s
     0     0 158147.332    0 1934 158088.266 158147.332  0.04%     -   45s
     0     0 158147.332    0  617 158088.266 158147.332  0.04%     -   45s
     0     0 158147.332    0  218 158088.266 158147.332  0.04%     -   45s
     0     0 158147.332    0  143 158088.266 158147.332  0.04%     -   45s
     0     0 158147.332    0  159 158088.266 158147.332  0.04%     -   45s
     0     0 158142.981    0  129 158088.266 158142.981  0.03%     -   45s
     0     0 158142.981    0  129 158088.266 158142.981  0.03%     -   45s
     0     0 158136.136    0  128 158088.266 158136.136  0.03%     -   46s
     0     0 158132.365    0  127 158088.266 158132.365  0.03%     -   46s
     0     0 158131.748    0   99 158088.266 158131.748  0.03%     -   46s
     0     0 158130.423    0   99 158088.266 158130.423  0.03%     -   46s
     0     0 158130.423    0   93 158088.266 158130.423  0.03%     -   46s
     0     0 158129.433    0   95 158088.266 158129.433  0.03%     -   47s
     0     0 158129.433    0   95 158088.266 158129.433  0.03%     -   47s
     0     0 158129.433    0   95 158088.266 158129.433  0.03%     -   47s
H    0     0                    158094.84946 158129.433  0.02%     -   47s
H    0     0                    158095.02479 158129.433  0.02%     -   47s
H    0     0                    158096.08013 158129.433  0.02%     -   47s
H    0     0                    158096.20662 158129.433  0.02%     -   47s
H    0     0                    158096.30405 158129.433  0.02%     -   47s
H    0     0                    158096.34855 158129.423  0.02%     -   47s
     0     0 158129.423    0 1245 158096.349 158129.423  0.02%     -   48s
     0     0 158129.423    0 1238 158096.349 158129.423  0.02%     -   48s
     0     0 158129.423    0  338 158096.349 158129.423  0.02%     -   48s
     0     0 158129.423    0  135 158096.349 158129.423  0.02%     -   48s
     0     0 158124.883    0   87 158096.349 158124.883  0.02%     -   48s
     0     0 158124.745    0   86 158096.349 158124.745  0.02%     -   48s
     0     0 158121.191    0   75 158096.349 158121.191  0.02%     -   48s
     0     0 158117.540    0   69 158096.349 158117.540  0.01%     -   49s
     0     0 158113.750    0   69 158096.349 158113.750  0.01%     -   49s
     0     0 158113.750    0   57 158096.349 158113.750  0.01%     -   49s
     0     0 158113.750    0   58 158096.349 158113.750  0.01%     -   49s
     0     0 158113.750    0   58 158096.349 158113.750  0.01%     -   49s
     0     0 158113.750    0  812 158096.349 158113.750  0.01%     -   49s
     0     0 158113.750    0  807 158096.349 158113.750  0.01%     -   49s
     0     0 158113.750    0  176 158096.349 158113.750  0.01%     -   49s
     0     0 158112.035    0   75 158096.349 158112.035  0.01%     -   49s

Cutting planes:
  Learned: 99
  Gomory: 53
  Cover: 23
  Implied bound: 120
  Clique: 3
  MIR: 226
  StrongCG: 1
  Flow cover: 38
  RLT: 489
  Relax-and-lift: 120
  BQP: 1

Explored 1 nodes (130804 simplex iterations) in 49.76 seconds (28.79 work units)
Thread count was 32 (of 192 available processors)

Solution count 10: 158096 158096 158096 ... 158080

Optimal solution found (tolerance 1.00e-04)
Best objective 1.580963485532e+05, best bound 1.581120348463e+05, gap 0.0099%

Solution Summary:
  Total keywords: 1915
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $158,096.35

Results saved to opt_results/bids/optimized_bids_bert_ridge_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_ridge_xgb_2026-01-12_full/optimized_bids_bert_ridge_xgb_lambda_10p0.csv

Top 10 bids:
                          keyword region        match      bid  predicted_clicks  predicted_epc  conv_value     cost      profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
     generative ai course roadmap      C  Broad match 0.102576         40.744542      87.980466 3584.723809 4.179423 3580.544386            True           NaN           NaN           NaN    10.0
     generative ai course roadmap      C Phrase match 0.125742         36.044243      94.150346 3393.577952 4.532271 3389.045681            True           NaN           NaN           NaN    10.0
     generative ai course roadmap      C  Exact match 0.125742         35.496280      85.875875 3048.274132 4.463369 3043.810763            True           NaN           NaN           NaN    10.0
     generative ai course roadmap      B  Broad match 0.200000         29.278696      99.965340 2926.854765 5.855739 2920.999026            True           NaN           NaN           NaN    10.0
     generative ai course roadmap      A  Broad match 0.309518         26.522688     103.968312 2757.519130 8.209262 2749.309868            True           NaN           NaN           NaN    10.0
     generative ai course roadmap      B  Exact match 0.200000         27.743116      97.743048 2711.696763 5.548623 2706.148140            True           NaN           NaN           NaN    10.0
    generative ai course syllabus      C  Broad match 0.101030         42.948899      57.775318 2481.386319 4.339138 2477.047181            True           NaN           NaN           NaN    10.0
    generative ai course syllabus      C Phrase match 0.123754         38.360332      63.942955 2452.872970 4.747263 2448.125707            True           NaN           NaN           NaN    10.0
generative ai course skillsfuture      A  Broad match 0.301674         27.697501      81.586530 2259.742994 8.355610 2251.387384            True           NaN           NaN           NaN    10.0
     generative ai course roadmap      B Phrase match 0.096725         21.253553     105.492792 2242.096631 2.055740 2240.040891            True           NaN           NaN           NaN    10.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan 12 21:36:12 EST 2026
