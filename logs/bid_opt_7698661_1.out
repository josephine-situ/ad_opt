========== Env & Dir ==========
Host: node3103
Start: Mon Jan  5 11:57:07 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 1 -> lambda=0
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1162 keywords from data/gkp/keywords_classified.csv (new=1001)
Generating BERT embeddings for 1162 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1162, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-05
  Keywords: 1162, Regions: 4, Matches: 3
  Total combinations: 13944
  Using target day for temporal features: 2026-01-05
  Created 13944 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  Loaded 1158 rows from Saved Keywords Stats 2025-12-25 at 16_34_09.csv
  After cleaning: 1156 rows with unique keywords
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             53.27% categorical (Missing)     (n=7428)
  Competition (indexed value)             53.27% numeric (0)               (n=7428)
  Top of page bid (low range)             70.05% numeric (0)               (n=9768)
  Top of page bid (high range)            70.05% numeric (0)               (n=9768)
  last_month_searches                     39.16% numeric (0)               (n=5460)
  three_month_avg                         39.16% numeric (0)               (n=5460)
  six_month_avg                           39.16% numeric (0)               (n=5460)
  mom_change                              39.16% numeric (0)               (n=5460)
  search_trend                            39.16% numeric (0)               (n=5460)
  Avg. CPC                                70.05% numeric (0)               (n=9768)
  -------------------------------------------------------------------------------------
  Total: Imputed 71460 missing values (7.76% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (13944, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_glm_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_glm_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using GLM EPC preprocessor from models/glm_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 5147/13944 rows (dropping 8797 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1401/5147 rows (dropping 3746 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 2635.79)
Saved bid bounds debug CSV: opt_results/cache/bert_glm_xgb_2026-01-05_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded GLM (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1401
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_glm_xgb_2026-01-05_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_glm_xgb_20260105_115846.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9474F 48-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 96 physical cores, 192 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 492231 rows, 462330 columns and 1386831 nonzeros (Max)
Model fingerprint: 0x195c44fe
Model has 0 linear objective coefficients
Model has 2802 quadratic objective terms
Model has 1401 quadratic constraints
Model has 5604 simple general constraints
  5604 INDICATOR
Variable types: 36426 continuous, 425904 integer (425904 binary)
Coefficient statistics:
  Matrix range     [7e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [0e+00, 0e+00]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [9e-03, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 454253 rows and 436331 columns
Presolve time: 0.22s
Presolved: 46385 rows, 27402 columns, 101962 nonzeros
Presolved model has 2802 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 12622 continuous, 14780 integer (14780 binary)
Performing another presolve...
Presolve removed 24822 rows and 17078 columns
Presolve time: 0.39s

Root relaxation: objective 1.945131e+05, 7590 iterations, 0.09 seconds (0.11 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 194513.052    0 4914          - 194513.052      -     -    1s
     0     0 194502.496    0 4914          - 194502.496      -     -    1s
     0     0 194462.133    0 4913          - 194462.133      -     -    1s
     0     0 99753.7219    0 2680          - 99753.7219      -     -    1s
     0     0 83035.9513    0 1494          - 83035.9513      -     -    1s
     0     0 76121.2324    0 1083          - 76121.2324      -     -    2s
     0     0 75334.6677    0  758          - 75334.6677      -     -    2s
     0     0 74452.3580    0  390          - 74452.3580      -     -    2s
     0     0 74277.5701    0  365          - 74277.5701      -     -    2s
     0     0 74000.7174    0  210          - 74000.7174      -     -    2s
H    0     0                    73525.332828 73997.9967  0.64%     -    2s
H    0     0                    73570.263591 73997.9967  0.58%     -    3s
H    0     0                    73572.744349 73997.9967  0.58%     -    3s
     0     0 73974.3566    0  212 73572.7443 73974.3566  0.55%     -    3s
     0     0 73917.7436    0  169 73572.7443 73917.7436  0.47%     -    3s
     0     0 73907.5410    0  170 73572.7443 73907.5410  0.46%     -    3s
     0     0 73881.8951    0  123 73572.7443 73881.8951  0.42%     -    3s
     0     0 73879.9085    0  122 73572.7443 73879.9085  0.42%     -    3s
     0     0 73879.4801    0  118 73572.7443 73879.4801  0.42%     -    3s
     0     0 73878.1945    0  118 73572.7443 73878.1945  0.42%     -    6s
     0     0 73878.1945    0  118 73572.7443 73878.1945  0.42%     -    6s
     0     0 73878.1945    0  118 73572.7443 73878.1945  0.42%     -    6s
H    0     0                    73702.157828 73878.1945  0.24%     -    7s
H    0     0                    73708.167877 73878.1945  0.23%     -    7s
H    0     0                    73772.413221 73878.1945  0.14%     -    7s
H    0     0                    73810.023957 73878.1945  0.09%     -    7s
     0     0 73878.1945    0 2116 73810.0240 73878.1945  0.09%     -    8s
     0     0 73878.1945    0 2196 73810.0240 73878.1945  0.09%     -    8s
     0     0 73878.1945    0 2200 73810.0240 73878.1945  0.09%     -    8s
     0     0 73878.1945    0  999 73810.0240 73878.1945  0.09%     -    8s
     0     0 73878.1945    0  193 73810.0240 73878.1945  0.09%     -    8s
     0     0 73857.7062    0   99 73810.0240 73857.7062  0.06%     -    8s
     0     0 73857.2969    0   97 73810.0240 73857.2969  0.06%     -    8s
     0     0 73848.3548    0   89 73810.0240 73848.3548  0.05%     -    8s
     0     0 73848.3548    0   89 73810.0240 73848.3548  0.05%     -    8s
     0     0 73829.5884    0   41 73810.0240 73829.5884  0.03%     -    9s
     0     0 73829.5884    0   41 73810.0240 73829.5884  0.03%     -    9s
     0     0 73826.5058    0   38 73810.0240 73826.5058  0.02%     -    9s
     0     0 73826.5058    0   37 73810.0240 73826.5058  0.02%     -    9s
     0     0 73822.2480    0   24 73810.0240 73822.2480  0.02%     -    9s
     0     0 73822.2480    0 1053 73810.0240 73822.2480  0.02%     -    9s
     0     0 73822.2480    0 1049 73810.0240 73822.2480  0.02%     -    9s
     0     0 73822.2480    0 1050 73810.0240 73822.2480  0.02%     -    9s
     0     0 73822.2480    0  158 73810.0240 73822.2480  0.02%     -    9s
     0     0 73822.2480    0   38 73810.0240 73822.2480  0.02%     -    9s
     0     0 73822.2480    0   38 73810.0240 73822.2480  0.02%     -    9s
     0     0 73821.0387    0   24 73810.0240 73821.0387  0.01%     -    9s
     0     0 73821.0387    0   24 73810.0240 73821.0387  0.01%     -    9s
     0     0 73819.9539    0   23 73810.0240 73819.9539  0.01%     -    9s
     0     0 73817.8148    0   16 73810.0240 73817.8148  0.01%     -   10s
     0     0 73817.8148    0   15 73810.0240 73817.8148  0.01%     -   10s
     0     0 73817.5038    0   14 73810.0240 73817.5038  0.01%     -   10s
     0     0 73817.5038    0   14 73810.0240 73817.5038  0.01%     -   10s
     0     0          -    0      73810.0240 73817.1170  0.01%     -   10s

Cutting planes:
  Learned: 100
  Gomory: 46
  Cover: 11
  Implied bound: 121
  MIR: 269
  Flow cover: 27
  RLT: 679
  Relax-and-lift: 72

Explored 1 nodes (37111 simplex iterations) in 10.19 seconds (7.56 work units)
Thread count was 32 (of 192 available processors)

Solution count 10: 73810 73810 73810 ... 73570.3

Optimal solution found (tolerance 1.00e-04)
Best objective 7.381002395702e+04, best bound 7.381711695997e+04, gap 0.0096%

Solution Summary:
  Total keywords: 1401
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $73,810.02

Results saved to opt_results/bids/optimized_bids_bert_glm_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_glm_xgb_2026-01-05_full/optimized_bids_bert_glm_xgb_lambda_0p0.csv

Top 10 bids:
                         keyword region       match      bid  predicted_clicks  predicted_epc  conv_value     cost     profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
       top generative ai courses      C Broad match 0.100007         11.961635      83.051025  993.426011 1.196250 992.229761            True           NaN           NaN           NaN     0.0
       top generative ai courses      A Broad match 0.410000          7.720444      98.732496  762.258745 3.165382 759.093363            True           NaN           NaN           NaN     0.0
       top generative ai courses    USA Broad match 0.716445          8.594504      82.826110  711.849357 6.157486 705.691871            True           NaN           NaN           NaN     0.0
       top generative ai courses      B Broad match 0.125862          6.696769     100.590011  673.628089 0.842868 672.785221            True           NaN           NaN           NaN     0.0
       generative ai top courses      B Broad match 0.260000          6.436606      89.913790  578.739624 1.673518 577.066107            True           NaN           NaN           NaN     0.0
       generative ai top courses      C Broad match 0.099538          7.926447      71.613682  567.642031 0.788982 566.853049            True           NaN           NaN           NaN     0.0
top generative ai courses online      C Broad match 0.123043         12.340650      45.996077  567.621490 1.518435 566.103056            True           NaN           NaN           NaN     0.0
 generative ai course curriculum      B Broad match 0.420000          6.791550      83.730113  568.657251 2.852451 565.804800            True           NaN           NaN           NaN     0.0
 generative ai course curriculum      C Broad match 0.103915          8.241382      64.550050  531.981626 0.856401 531.125225            True           NaN           NaN           NaN     0.0
           ai generative courses      C Broad match 0.100965          9.580808      55.456876  531.321689 0.967331 530.354358            True           NaN           NaN           NaN     0.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan  5 11:59:00 EST 2026
