========== Env & Dir ==========
Host: node1603
Start: Mon Jan 12 21:20:35 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 0 -> lambda=0
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1798 keywords from data/gkp/keywords_classified.csv (new=995)
Generating BERT embeddings for 1798 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1798, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-12
  Keywords: 1798, Regions: 4, Matches: 3
  Total combinations: 21576
  Using target day for temporal features: 2026-01-12
  Created 21576 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  Loaded 1749 rows from Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  After cleaning: 1747 rows with unique keywords
  Fuzzy-matched 468 rows using similar-word normalization
  Example fuzzy mappings: ['advanced generative ai courses -> advanced generative ai course', 'ai certification -> artificial intelligence certification', 'ai certification courses -> ai certificate course', 'ai courses -> artificial intelligence course', 'ai for engineers -> ai for engineering']
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             37.99% categorical (Missing)     (n=8196)
  Competition (indexed value)             37.99% numeric (0)               (n=8196)
  Top of page bid (low range)             54.12% numeric (0)               (n=11676)
  Top of page bid (high range)            54.12% numeric (0)               (n=11676)
  _kw_key                                 71.19% categorical (Missing)     (n=15360)
  last_month_searches                     26.64% numeric (0)               (n=5748)
  three_month_avg                         26.64% numeric (0)               (n=5748)
  six_month_avg                           26.64% numeric (0)               (n=5748)
  mom_change                              26.64% numeric (0)               (n=5748)
  search_trend                            26.64% numeric (0)               (n=5748)
  Avg. CPC                                54.12% numeric (0)               (n=11676)
  -------------------------------------------------------------------------------------
  Total: Imputed 95520 missing values (6.61% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (21576, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_ridge_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_ridge_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using Ridge EPC preprocessor from models/ridge_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 9104/21576 rows (dropping 12472 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1915/9104 rows (dropping 7189 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 745347.56)
Loading embeddings from data/clean/unique_keyword_embeddings_bert.csv...
  Loaded 154 rows with complete embeddings
Saved bid bounds debug CSV: opt_results/cache/bert_ridge_xgb_2026-01-12_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded RIDGE (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1915
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_ridge_xgb_2026-01-12_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_ridge_xgb_20260112_212202.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9474F 48-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 96 physical cores, 192 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 759520 rows, 653015 columns and 2096428 nonzeros (Max)
Model fingerprint: 0xcd701287
Model has 0 linear objective coefficients
Model has 3830 quadratic objective terms
Model has 1915 quadratic constraints
Model has 7660 simple general constraints
  7660 INDICATOR
Variable types: 49790 continuous, 603225 integer (603225 binary)
Coefficient statistics:
  Matrix range     [5e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [0e+00, 0e+00]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [3e-02, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 683480 rows and 603795 columns
Presolve time: 0.59s
Presolved: 87531 rows, 51137 columns, 201419 nonzeros
Presolved model has 3830 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 20629 continuous, 30508 integer (30508 binary)
Performing another presolve...
Presolve removed 52223 rows and 30633 columns
Presolve time: 0.92s
Deterministic concurrent LP optimizer: primal and dual simplex
Showing primal log only...

Concurrent spin time: 0.04s

Solved with dual simplex

Root relaxation: objective 5.069095e+05, 12743 iterations, 0.34 seconds (0.34 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 506909.489    0 8460          - 506909.489      -     -    2s
     0     0 502541.741    0 8423          - 502541.741      -     -    2s
     0     0 498224.207    0 8396          - 498224.207      -     -    3s
     0     0 493753.012    0 8374          - 493753.012      -     -    3s
     0     0 490615.304    0 8369          - 490615.304      -     -    3s
     0     0 235928.537    0 5677          - 235928.537      -     -    5s
     0     0 208275.202    0 3515          - 208275.202      -     -    5s
     0     0 179831.794    0 2255          - 179831.794      -     -    6s
     0     0 170583.911    0 1753          - 170583.911      -     -    6s
     0     0 163210.106    0 1395          - 163210.106      -     -    8s
     0     0 161916.413    0 1392          - 161916.413      -     -    8s
     0     0 159280.615    0  953          - 159280.615      -     -    9s
     0     0 159040.126    0  889          - 159040.126      -     -    9s
     0     0 158609.495    0  780          - 158609.495      -     -   10s
H    0     0                    156550.51803 158604.995  1.31%     -   10s
H    0     0                    157189.26349 158604.995  0.90%     -   10s
H    0     0                    157339.95193 158604.995  0.80%     -   10s
H    0     0                    157462.34226 158604.995  0.73%     -   10s
H    0     0                    157469.43222 158604.995  0.72%     -   10s
H    0     0                    157474.68009 158604.995  0.72%     -   11s
H    0     0                    157485.87567 158604.995  0.71%     -   11s
H    0     0                    157486.91782 158604.995  0.71%     -   11s
     0     0 158530.006    0  776 157486.918 158530.006  0.66%     -   11s
     0     0 158530.006    0  774 157486.918 158530.006  0.66%     -   11s
     0     0 158266.508    0  604 157486.918 158266.508  0.50%     -   12s
     0     0 158266.508    0  604 157486.918 158266.508  0.50%     -   12s
     0     0 158209.281    0  593 157486.918 158209.281  0.46%     -   13s
     0     0 158118.871    0  540 157486.918 158118.871  0.40%     -   13s
H    0     0                    157562.82328 158092.063  0.34%     -   14s
H    0     0                    157564.64368 158092.063  0.33%     -   14s
H    0     0                    157578.87819 158092.063  0.33%     -   14s
     0     0 158092.063    0  545 157578.878 158092.063  0.33%     -   14s
     0     0 158092.063    0  571 157578.878 158092.063  0.33%     -   15s
     0     0 158028.348    0  483 157578.878 158028.348  0.29%     -   17s
     0     0 158028.348    0 4971 157578.878 158028.348  0.29%     -   18s
     0     0 158028.348    0 4976 157578.878 158028.348  0.29%     -   19s
     0     0 158028.348    0 4976 157578.878 158028.348  0.29%     -   19s
     0     0 158028.348    0 4974 157578.878 158028.348  0.29%     -   19s
     0     0 158028.348    0 2825 157578.878 158028.348  0.29%     -   20s
     0     0 158028.348    0  881 157578.878 158028.348  0.29%     -   20s
     0     0 158028.348    0  375 157578.878 158028.348  0.29%     -   20s
     0     0 158028.348    0  381 157578.878 158028.348  0.29%     -   20s
     0     0 157828.386    0  268 157578.878 157828.386  0.16%     -   21s
     0     0 157828.377    0  267 157578.878 157828.377  0.16%     -   21s
     0     0 157798.917    0  240 157578.878 157798.917  0.14%     -   21s
     0     0 157775.271    0  209 157578.878 157775.271  0.12%     -   21s
     0     0 157775.271    0 3709 157578.878 157775.271  0.12%     -   22s
     0     0 157775.271    0 3724 157578.878 157775.271  0.12%     -   22s
     0     0 157775.271    0 3719 157578.878 157775.271  0.12%     -   22s
     0     0 157775.271    0 1742 157578.878 157775.271  0.12%     -   23s
     0     0 157775.271    0  382 157578.878 157775.271  0.12%     -   23s
     0     0 157775.271    0  177 157578.878 157775.271  0.12%     -   23s
     0     0 157775.271    0  177 157578.878 157775.271  0.12%     -   23s
     0     0 157765.420    0  176 157578.878 157765.420  0.12%     -   24s
     0     0 157765.420    0  176 157578.878 157765.420  0.12%     -   24s
     0     0 157715.878    0  149 157578.878 157715.878  0.09%     -   24s
     0     0 157715.803    0  149 157578.878 157715.803  0.09%     -   24s
     0     0 157702.469    0  149 157578.878 157702.469  0.08%     -   27s
     0     0 157702.469    0  149 157578.878 157702.469  0.08%     -   27s
     0     0 157702.469    0  149 157578.878 157702.469  0.08%     -   27s
H    0     0                    157584.69157 157702.469  0.07%     -   28s
H    0     0                    157584.75056 157702.469  0.07%     -   28s
H    0     0                    157585.10031 157702.469  0.07%     -   29s
H    0     0                    157585.54813 157702.469  0.07%     -   29s
H    0     0                    157587.17920 157702.469  0.07%     -   29s
     0     0 157702.391    0 2933 157587.179 157702.391  0.07%     -   31s
     0     0 157702.391    0 2931 157587.179 157702.391  0.07%     -   31s
     0     0 157702.391    0 2931 157587.179 157702.391  0.07%     -   31s
     0     0 157702.391    0 1192 157587.179 157702.391  0.07%     -   32s
     0     0 157702.391    0  216 157587.179 157702.391  0.07%     -   32s
     0     0 157702.391    0  126 157587.179 157702.391  0.07%     -   32s
     0     0 157702.391    0  125 157587.179 157702.391  0.07%     -   32s
     0     0 157692.405    0  115 157587.179 157692.405  0.07%     -   32s
     0     0 157657.047    0   97 157587.179 157657.047  0.04%     -   32s
     0     0 157657.047    0   97 157587.179 157657.047  0.04%     -   32s
     0     0 157652.294    0  103 157587.179 157652.294  0.04%     -   32s
     0     0 157652.294    0  103 157587.179 157652.294  0.04%     -   32s
     0     0 157638.563    0   87 157587.179 157638.563  0.03%     -   33s
     0     0 157638.563    0 1862 157587.179 157638.563  0.03%     -   33s
     0     0 157638.563    0 1845 157587.179 157638.563  0.03%     -   33s
     0     0 157638.563    0  613 157587.179 157638.563  0.03%     -   34s
     0     0 157638.563    0  140 157587.179 157638.563  0.03%     -   34s
     0     0 157634.138    0  113 157587.179 157634.138  0.03%     -   34s
     0     0 157634.128    0  112 157587.179 157634.128  0.03%     -   34s
     0     0 157632.461    0  107 157587.179 157632.461  0.03%     -   34s
     0     0 157626.008    0   89 157587.179 157626.008  0.02%     -   34s
     0     0 157622.760    0   81 157587.179 157622.760  0.02%     -   34s
     0     0 157621.945    0   69 157587.179 157621.945  0.02%     -   34s
     0     0 157619.839    0   69 157587.179 157619.839  0.02%     -   34s
     0     0 157619.839    0   69 157587.179 157619.839  0.02%     -   34s
     0     0 157619.839    0   69 157587.179 157619.839  0.02%     -   35s
     0     0 157619.839    0 1161 157587.179 157619.839  0.02%     -   35s
     0     0 157619.839    0 1157 157587.179 157619.839  0.02%     -   35s
     0     0 157619.839    0  304 157587.179 157619.839  0.02%     -   35s
     0     0 157619.839    0  130 157587.179 157619.839  0.02%     -   35s
     0     0 157619.839    0   53 157587.179 157619.839  0.02%     -   35s
     0     0 157619.088    0   58 157587.179 157619.088  0.02%     -   35s
     0     0 157613.290    0   51 157587.179 157613.290  0.02%     -   35s
     0     0 157610.981    0   51 157587.179 157610.981  0.02%     -   36s
     0     0 157610.981    0   51 157587.179 157610.981  0.02%     -   36s
     0     0 157610.981    0   51 157587.179 157610.981  0.02%     -   36s
H    0     0                    157587.95187 157610.981  0.01%     -   36s
     0     0 157610.981    0  827 157587.952 157610.981  0.01%     -   36s
     0     0 157610.981    0  826 157587.952 157610.981  0.01%     -   36s
     0     0 157610.981    0  196 157587.952 157610.981  0.01%     -   36s
     0     0 157610.981    0   63 157587.952 157610.981  0.01%     -   36s
     0     0 157607.273    0   36 157587.952 157607.273  0.01%     -   36s
     0     0 157607.036    0   34 157587.952 157607.036  0.01%     -   36s
     0     0 157606.589    0   21 157587.952 157606.589  0.01%     -   37s
     0     0 157606.526    0   21 157587.952 157606.526  0.01%     -   37s
     0     0 157606.021    0   25 157587.952 157606.021  0.01%     -   37s
     0     0 157605.808    0   25 157587.952 157605.808  0.01%     -   37s
     0     0 157605.808    0   25 157587.952 157605.808  0.01%     -   37s
H    0     0                    157595.92189 157605.808  0.01%     -   37s

Cutting planes:
  Learned: 86
  Gomory: 44
  Cover: 30
  Implied bound: 149
  Clique: 2
  MIR: 230
  Flow cover: 44
  RLT: 515
  Relax-and-lift: 82
  BQP: 1

Explored 1 nodes (125270 simplex iterations) in 37.53 seconds (26.15 work units)
Thread count was 32 (of 192 available processors)

Solution count 10: 157596 157588 157587 ... 157565

Optimal solution found (tolerance 1.00e-04)
Best objective 1.575959218868e+05, best bound 1.576057994265e+05, gap 0.0063%

Solution Summary:
  Total keywords: 1915
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $157,595.92

Results saved to opt_results/bids/optimized_bids_bert_ridge_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_ridge_xgb_2026-01-12_full/optimized_bids_bert_ridge_xgb_lambda_0p0.csv

Top 10 bids:
                          keyword region        match      bid  predicted_clicks  predicted_epc  conv_value     cost      profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
     generative ai course roadmap      C  Broad match 0.102576         40.744542      87.980466 3584.723809 4.179423 3580.544386            True           NaN           NaN           NaN     0.0
     generative ai course roadmap      C Phrase match 0.125742         36.044243      94.150346 3393.577952 4.532271 3389.045681            True           NaN           NaN           NaN     0.0
     generative ai course roadmap      C  Exact match 0.125742         35.496280      85.875875 3048.274132 4.463369 3043.810763            True           NaN           NaN           NaN     0.0
     generative ai course roadmap      B  Broad match 0.200000         29.278696      99.965340 2926.854765 5.855739 2920.999026            True           NaN           NaN           NaN     0.0
     generative ai course roadmap      A  Broad match 0.309518         26.522688     103.968312 2757.519130 8.209262 2749.309868            True           NaN           NaN           NaN     0.0
     generative ai course roadmap      B  Exact match 0.200000         27.743116      97.743048 2711.696763 5.548623 2706.148140            True           NaN           NaN           NaN     0.0
    generative ai course syllabus      C  Broad match 0.101030         42.948899      57.775318 2481.386319 4.339138 2477.047181            True           NaN           NaN           NaN     0.0
    generative ai course syllabus      C Phrase match 0.123754         38.360332      63.942955 2452.872970 4.747263 2448.125707            True           NaN           NaN           NaN     0.0
generative ai course skillsfuture      A  Broad match 0.301674         27.697501      81.586530 2259.742994 8.355610 2251.387384            True           NaN           NaN           NaN     0.0
     generative ai course roadmap      B Phrase match 0.096725         21.253553     105.492792 2242.096631 2.055740 2240.040891            True           NaN           NaN           NaN     0.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan 12 21:22:43 EST 2026
