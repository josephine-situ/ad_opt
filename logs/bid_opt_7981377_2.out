========== Env & Dir ==========
Host: node3114
Start: Mon Jan 12 21:20:35 EST 2026
Submit dir: /orcd/home/002/jositu/ad_opt
PWD: /orcd/home/002/jositu/ad_opt
===============================
Load modules...
Activate environment...
Running bid_optimization.py with GLM for EPC and XGB MSE models for clicks
SLURM_ARRAY_TASK_ID: 2 -> lambda=100
======================================================================
Bid Optimization with Linear Programming
======================================================================
Embedding method: bert
======================================================================
Loaded 1798 keywords from data/gkp/keywords_classified.csv (new=995)
Generating BERT embeddings for 1798 keywords...
  Using SentenceTransformer model: all-MiniLM-L6-v2
  Generated embeddings with shape (1798, 50)
Loading weights for embedding method 'bert'...
  Loading from CSV files...
  Loaded from CSV files ✓
Creating feature matrix...
  Target day: 2026-01-12
  Keywords: 1798, Regions: 4, Matches: 3
  Total combinations: 21576
  Using target day for temporal features: 2026-01-12
  Created 21576 keyword-region-match combinations
  Using GKP keyword stats from data/gkp (no historical training merge)
[Step 5] Loading Google Keyword Planner data...
  Found GKP file: Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  Loaded 1749 rows from Saved Keywords Stats 2026-01-11 at 17_51_34.csv
  After cleaning: 1747 rows with unique keywords
  Fuzzy-matched 468 rows using similar-word normalization
  Example fuzzy mappings: ['advanced generative ai courses -> advanced generative ai course', 'ai certification -> artificial intelligence certification', 'ai certification courses -> ai certificate course', 'ai courses -> artificial intelligence course', 'ai for engineers -> ai for engineering']
[Step 5.5] Imputing missing data...

  Imputation Summary:
  -------------------------------------------------------------------------------------
  Competition                             37.99% categorical (Missing)     (n=8196)
  Competition (indexed value)             37.99% numeric (0)               (n=8196)
  Top of page bid (low range)             54.12% numeric (0)               (n=11676)
  Top of page bid (high range)            54.12% numeric (0)               (n=11676)
  _kw_key                                 71.19% categorical (Missing)     (n=15360)
  last_month_searches                     26.64% numeric (0)               (n=5748)
  three_month_avg                         26.64% numeric (0)               (n=5748)
  six_month_avg                           26.64% numeric (0)               (n=5748)
  mom_change                              26.64% numeric (0)               (n=5748)
  search_trend                            26.64% numeric (0)               (n=5748)
  Avg. CPC                                54.12% numeric (0)               (n=11676)
  -------------------------------------------------------------------------------------
  Total: Imputed 95520 missing values (6.61% of total data)
  Keeping categorical features as strings (both models need raw categoricals)
  Final feature matrix shape: (21576, 68)
  Columns: ['Region', 'Match type', 'bert_0', 'bert_1', 'bert_2', 'bert_3', 'bert_4', 'bert_5', 'bert_6', 'bert_7', 'bert_8', 'bert_9', 'bert_10', 'bert_11', 'bert_12']...
Feature matrix has 68 total features
Saved X_ort to opt_results/feature_matrices/X_ort_bert_ridge_xgb.csv
Saved mapping to opt_results/feature_matrices/mapping_bert_ridge_xgb.csv
  Using XGB clicks model from models/xgb_mse_bert_clicks.json
  Using Ridge EPC preprocessor from models/ridge_bert_epc_preprocess.joblib

Bid=0 feasibility filter: keeping 9104/21576 rows (dropping 12472 with EPC<0 or clicks<0 at bid=0)
Loading training data from data/clean/ad_opt_data_bert.csv for Trust Ellipsoid...

Trust-Ellipsoid: keeping 1915/9104 rows (dropping 7189 extrapolations)
  (Threshold Chi2: 90.80, Max Obs Dist: 745347.56)
Loading embeddings from data/clean/unique_keyword_embeddings_bert.csv...
  Loaded 154 rows with complete embeddings
Saved bid bounds debug CSV: opt_results/cache/bert_ridge_xgb_2026-01-12_full/clicks_bid_bounds_debug.csv

Solving bid optimization with embedded RIDGE (epc) + XGB (clicks) constraints...
  Budget: $400.00
  Keywords: 1915
Set parameter WLSAccessID
Set parameter WLSSecret
Set parameter LicenseID to value 2760147
Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Set parameter OutputFlag to value 1
Set parameter TimeLimit to value 300
  Embedding clicks XGB constraints (path-based formulation)...

  Base formulation saved to opt_results/cache/bert_ridge_xgb_2026-01-12_full/base_formulation.lp

  Model formulation saved to opt_results/formulations/bid_optimization_ridge_xgb_20260112_213023.lp
Set parameter NonConvex to value 2
Gurobi Optimizer version 13.0.0 build v13.0.0rc1 (linux64 - "Rocky Linux 8.10 (Green Obsidian)")

CPU model: AMD EPYC 9474F 48-Core Processor, instruction set [SSE2|AVX|AVX2|AVX512]
Thread count: 96 physical cores, 192 logical processors, using up to 32 threads

Non-default parameters:
TimeLimit  300
NonConvex  2

Academic license 2760147 - for non-commercial use only - registered to jo___@mit.edu
Optimize a model with 759520 rows, 653015 columns and 2096428 nonzeros (Max)
Model fingerprint: 0xbc0aa724
Model has 1155 linear objective coefficients
Model has 3830 quadratic objective terms
Model has 1915 quadratic constraints
Model has 7660 simple general constraints
  7660 INDICATOR
Variable types: 49790 continuous, 603225 integer (603225 binary)
Coefficient statistics:
  Matrix range     [5e-04, 5e+01]
  QMatrix range    [1e+00, 1e+00]
  QLMatrix range   [1e+00, 1e+00]
  Objective range  [1e+02, 1e+02]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 4e+04]
  RHS range        [3e-02, 4e+02]
  GenCon coe range [1e+00, 1e+00]
Presolve removed 683480 rows and 603795 columns
Presolve time: 0.37s
Presolved: 87531 rows, 51137 columns, 201419 nonzeros
Presolved model has 3830 bilinear constraint(s)

Solving non-convex MIQCP to global optimality

Variable types: 20629 continuous, 30508 integer (30508 binary)
Performing another presolve...
Presolve removed 52223 rows and 30633 columns
Presolve time: 0.87s
Deterministic concurrent LP optimizer: primal and dual simplex
Showing primal log only...

Concurrent spin time: 0.00s

Solved with dual simplex

Root relaxation: objective 9.286581e+05, 12772 iterations, 0.19 seconds (0.19 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 928658.115    0 8985          - 928658.115      -     -    2s
     0     0 391372.535    0 6537          - 391372.535      -     -    3s
     0     0 319493.508    0 5810          - 319493.508      -     -    4s
     0     0 230613.794    0 4619          - 230613.794      -     -    4s
     0     0 209620.564    0 3886          - 209620.564      -     -    5s
     0     0 191553.118    0 2730          - 191553.118      -     -    6s
     0     0 177907.596    0 2651          - 177907.596      -     -    6s
     0     0 172083.271    0 1963          - 172083.271      -     -    7s
     0     0 169458.487    0 1907          - 169458.487      -     -    7s
     0     0 167598.935    0 1584          - 167598.935      -     -    8s
     0     0 167254.291    0 1665          - 167254.291      -     -    8s
     0     0 166405.481    0 1446          - 166405.481      -     -    8s
     0     0 166403.204    0 1446          - 166403.204      -     -    9s
     0     0 166403.204    0 1440          - 166403.204      -     -    9s
     0     2 166399.609    0 1440          - 166399.609      -     -   18s
    15    32 165774.067    4 1428          - 166346.756      -   9.7   20s
H  163   198                    143141.82942 166242.717  16.1%   9.7   24s
   197   230 165280.945    9 1414 143141.829 166242.717  16.1%  10.0   25s
H  209   230                    143141.82943 166242.717  16.1%   9.8   25s
H  363   395                    143390.56212 166242.717  15.9%   9.4   28s
H  365   395                    152463.97113 166242.717  9.04%   9.4   28s
H  371   395                    154167.64606 166242.717  7.83%   9.5   28s
H  376   395                    154932.61035 166242.717  7.30%   9.4   28s
   458   553 165165.662   13 1383 154932.610 166242.717  7.30%   9.6   30s
  1044  1126 164982.394   25 1342 154932.610 166242.717  7.30%   9.1   35s
H 1168  1189                    156402.19919 166242.717  6.29%   9.2   36s
H 1184  1189                    156473.30361 166242.717  6.24%   9.2   36s
  1564  1666 164836.242   38 1326 156473.304 166242.717  6.24%   8.8   40s
  2090  2215 164644.691   49 1269 156473.304 166242.717  6.24%   8.4   45s
H 2289  2312                    156506.78583 166242.717  6.22%   8.4   47s
H 2310  2312                    156526.13688 166242.717  6.21%   8.4   47s
  2411  2556 164510.293   54 1241 156526.137 166242.717  6.21%   8.3   50s
  3044  3185 164384.089   68 1185 156526.137 166242.717  6.21%   8.0   55s
H 3369  3398                    157166.10593 166242.717  5.78%   7.8   58s
H 3376  3398                    157712.80668 166242.717  5.41%   7.8   58s
H 3381  3398                    157904.99797 166242.717  5.28%   7.8   58s
H 3383  3398                    158811.44171 166242.717  4.68%   7.8   58s
H 3439  3503                    160393.24232 166242.717  3.65%   7.7   59s
H 3444  3471                    160918.49527 166242.717  3.31%   7.7   59s
H 3449  3460                    161015.62496 166242.717  3.25%   7.7   59s
  3566  3558 164301.913   82 1150 161015.625 166242.717  3.25%   7.7   61s
  4025  4061 164050.445   93 1203 161015.625 166242.717  3.25%  16.4   65s
  4585  4627 163969.948  105 1155 161015.625 166242.717  3.25%  16.0   70s
H 4843  4587                    161696.47609 166242.717  2.81%  16.0   73s
H 4844  4580                    161734.03674 166242.717  2.79%  16.0   73s
H 4845  4573                    161759.05500 166242.717  2.77%  16.0   73s
H 4849  4564                    161795.03215 166242.717  2.75%  16.0   73s
  4876  4684 163899.251  113 1129 161795.032 166217.246  2.73%  16.5   75s
  5558  5411 163703.839  129 1073 161795.032 166217.246  2.73%  17.1   81s
  6047  5981 163611.080  138 1040 161795.032 166217.246  2.73%  16.3   86s
  6662  6629 163409.354  152  983 161795.032 166217.246  2.73%  15.8   90s
H 6999  6604                    162015.35689 166210.698  2.59%  15.5   92s
H 7000  6489                    162181.06868 166210.698  2.48%  15.5   92s
H 7006  6420                    162309.11607 166210.698  2.40%  15.5   92s
  7068  6428 163318.643  163  943 162309.116 166210.698  2.40%  15.6   95s
H 7161  6465                    162337.58141 166210.698  2.39%  16.0   99s
  7190  6718 163312.165  166  931 162337.581 166210.698  2.39%  16.2  102s
  7821  7358 163225.838  182  869 162337.581 166210.698  2.39%  15.6  108s
  8101  7754 163184.764  187  877 162337.581 166210.698  2.39%  15.4  110s
  8956  8647 163104.593  210  804 162337.581 166210.698  2.39%  14.8  117s
  9424  9135 163061.736  222  762 162337.581 166202.837  2.38%  14.5  120s
H 9914  9066                    162599.36057 166202.837  2.22%  14.1  123s
H10056  9057                    162617.39591 166202.837  2.20%  14.0  123s
 10070  9375 162998.173  236  727 162617.396 166202.837  2.20%  14.0  126s
 10405  9852 162944.185  244  699 162617.396 166202.837  2.20%  13.9  130s
 11466 10921 162862.435  268  615 162617.396 166177.335  2.19%  13.5  137s
 12031 11489 162781.149  279  595 162617.396 166170.525  2.18%  13.5  141s
 13214 12488     cutoff  307      162617.396 166170.525  2.18%  12.9  149s
 13643 13153 165389.515   13 1511 162617.396 166170.525  2.18%  12.8  153s
 14331 13788 164535.294   33 1409 162617.396 166170.525  2.18%  12.6  157s
H15020 11886                    163159.14353 166093.335  1.80%  12.7  159s
H15020 11772                    163178.97987 166093.335  1.79%  12.7  159s
H15020 11684                    163197.46108 166093.335  1.77%  12.7  160s
 15021 11569 163548.733  139 4742 163197.461 166158.115  1.81%  12.7  167s
H15022 10991                    163203.20132 166158.115  1.81%  12.7  168s
 15026 10993 163830.249  152  993 163203.201 166158.115  1.81%  12.7  170s
 15034 10999 163688.464   72  633 163203.201 164112.644  0.56%  12.7  176s
 15039 11002 163714.736  157  614 163203.201 163885.544  0.42%  12.7  180s
H15040 10453                    163207.00487 163817.281  0.37%  12.7  181s
H15046  9933                    163207.10579 163751.256  0.33%  12.7  184s
H15048  9437                    163208.22188 163740.003  0.33%  12.7  184s
 15049  9438 163728.260  177  525 163208.222 163740.003  0.33%  12.7  185s
 15056  9442 163537.974  137  425 163208.222 163612.449  0.25%  12.7  190s
H15063  8976                    163208.22192 163568.456  0.22%  15.2  193s
H15065  8528                    163208.71867 163568.456  0.22%  15.2  194s
H15066  8103                    163212.90776 163568.456  0.22%  15.2  194s
H15066  7697                    163213.73584 163568.456  0.22%  15.2  194s
 15067  7697 163568.456   26  462 163213.736 163568.456  0.22%  15.2  195s
H15067  7312                    163217.07733 163568.456  0.22%  15.2  195s
H15068  6948                    163218.13965 163568.456  0.21%  15.2  195s
H15068  6600                    163218.46027 163568.456  0.21%  15.2  195s
H15068  6270                    163218.66941 163568.456  0.21%  15.2  195s
H15069  5957                    163220.62786 163539.006  0.20%  15.2  196s
H15072  5661                    163222.66960 163492.160  0.17%  15.2  199s
 15074  5662 163490.829   57  291 163222.670 163490.829  0.16%  15.2  200s
H15085  5387                    163222.90552 163467.486  0.15%  17.0  204s
 15088  5389 163436.520  130  215 163222.906 163436.520  0.13%  17.0  205s
H15110  5133                    163223.15207 163390.711  0.10%  17.0  208s
H15110  4876                    163223.32861 163390.711  0.10%  17.0  208s
 15116  4880 163375.221  155  200 163223.329 163375.221  0.09%  17.0  210s
H15126  4641                    163231.58402 163349.255  0.07%  17.0  211s
H15126  4408                    163231.58638 163349.255  0.07%  17.0  211s
H15126  4187                    163231.63576 163349.255  0.07%  17.0  211s
 15148  4203 163334.129  118  146 163231.636 163334.129  0.06%  18.3  215s
H15164  4002                    163231.67956 163293.881  0.04%  18.3  216s
H15164  3802                    163232.14914 163293.881  0.04%  18.3  216s
 15193  3822 163260.042  119   65 163232.149 163260.042  0.02%  19.2  220s

Cutting planes:
  Learned: 120
  Gomory: 59
  Cover: 42
  Implied bound: 89
  Projected implied bound: 60
  Clique: 4
  MIR: 147
  Mixing: 2
  StrongCG: 2
  Flow cover: 282
  RLT: 559
  Relax-and-lift: 147

Explored 15204 nodes (356485 simplex iterations) in 220.91 seconds (96.86 work units)
Thread count was 32 (of 192 available processors)

Solution count 10: 163232 163232 163232 ... 163221

Optimal solution found (tolerance 1.00e-04)
Best objective 1.632321491381e+05, best bound 1.632481920656e+05, gap 0.0098%

Solution Summary:
  Total keywords: 1915
  Total spend: $400.00
  Predicted profit (+ exploration bonus): $163,232.15

Results saved to opt_results/bids/optimized_bids_bert_ridge_xgb.csv
Sweep copy saved to opt_results/bids/lambda_sweep/bert_ridge_xgb_2026-01-12_full/optimized_bids_bert_ridge_xgb_lambda_100p0.csv

Top 10 bids:
                          keyword region        match      bid  predicted_clicks  predicted_epc  conv_value     cost      profit  is_new_keyword  hist_min_cpc  hist_avg_cpc  hist_max_cpc  lambda
     generative ai course roadmap      C  Broad match 0.102576         40.744542      87.980466 3584.723809 4.179423 3580.544386            True           NaN           NaN           NaN   100.0
     generative ai course roadmap      C Phrase match 0.125742         36.044243      94.150346 3393.577952 4.532271 3389.045681            True           NaN           NaN           NaN   100.0
     generative ai course roadmap      C  Exact match 0.125742         35.496280      85.875875 3048.274132 4.463369 3043.810763            True           NaN           NaN           NaN   100.0
     generative ai course roadmap      B  Broad match 0.200000         29.278696      99.965340 2926.854765 5.855739 2920.999026            True           NaN           NaN           NaN   100.0
     generative ai course roadmap      A  Broad match 0.309518         26.522688     103.968312 2757.519130 8.209262 2749.309868            True           NaN           NaN           NaN   100.0
     generative ai course roadmap      B  Exact match 0.200000         27.743116      97.743048 2711.696763 5.548623 2706.148140            True           NaN           NaN           NaN   100.0
    generative ai course syllabus      C  Broad match 0.101030         42.948899      57.775318 2481.386319 4.339138 2477.047181            True           NaN           NaN           NaN   100.0
    generative ai course syllabus      C Phrase match 0.123754         38.360332      63.942955 2452.872970 4.747263 2448.125707            True           NaN           NaN           NaN   100.0
generative ai course skillsfuture      A  Broad match 0.301674         27.697501      81.586530 2259.742994 8.355610 2251.387384            True           NaN           NaN           NaN   100.0
     generative ai course roadmap      B Phrase match 0.096725         21.253553     105.492792 2242.096631 2.055740 2240.040891            True           NaN           NaN           NaN   100.0

======================================================================
✓ Bid optimization completed successfully!
======================================================================
End: Mon Jan 12 21:34:07 EST 2026
